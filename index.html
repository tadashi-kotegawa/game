<!DOCTYPE html>
<html lang="ja">
<!--
    NEO-TYPE - Japanese Typing Game
    Converted from React to Vanilla JavaScript
    
    Features:
    - Adaptive difficulty with weak key tracking
    - 585 words + 200 legal terms
    - Real mode with backspace support
    - Multiple display modes (IME, Guide, Input)
    - Sound effects with Web Audio API
    - LocalStorage for stats persistence
    
    No build tools required - just open in a browser!
    © Tadashi Kotegawa
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO-TYPE - さよなら苦手キー</title>
    <style>
        /* Reset and base styles */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; }
        
        /* Custom animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { opacity: 1; transform: translateY(-20px) scale(1.1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        .animate-float-up {
            animation: floatUp 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-in { animation: fadeIn 0.2s ease-in; }
        .fade-in { animation: fadeIn 0.3s ease-in; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .zoom-in-95 { animation: zoomIn 0.2s ease-out; }

        .grid-stack {
            display: grid;
        }
        
        .grid-stack > * {
            grid-area: 1 / 1;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgb(30, 41, 59);
        }
        ::-webkit-scrollbar-thumb {
            background: rgb(71, 85, 105);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(100, 116, 139);
        }


        :root {
            --settings-bg: #0b1220;
            --settings-surface: rgba(255, 255, 255, 0.03);
            --settings-surface-hover: rgba(255, 255, 255, 0.05);
            --settings-panel: rgba(12, 20, 34, 0.96);
            --settings-text: rgba(255, 255, 255, 0.95);
            --settings-text-muted: rgba(255, 255, 255, 0.7);
            --settings-text-subtle: rgba(255, 255, 255, 0.55);
            --settings-accent: #14b8a6;
            --settings-accent-soft: rgba(20, 184, 166, 0.24);
            --settings-radius: 12px;
            --settings-control-height: 44px;
            --settings-space-1: 8px;
            --settings-space-2: 16px;
            --settings-space-3: 24px;
        }

        .settings-panel {
            background: var(--settings-panel);
            border-radius: var(--settings-radius);
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
            padding: var(--settings-space-3);
        }
        .settings-section { display: flex; flex-direction: column; gap: var(--settings-space-2); }
        .settings-section-title {
            display: flex; align-items: center; gap: var(--settings-space-1);
            font-size: 12px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
            color: var(--settings-text-subtle);
        }
        .setting-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 220px;
            align-items: center;
            gap: var(--settings-space-2);
            background: var(--settings-surface);
            border-radius: var(--settings-radius);
            padding: 12px 14px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
            transition: background-color 0.2s ease;
        }
        .setting-row:hover { background: var(--settings-surface-hover); }
        .setting-meta { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        .setting-title { font-size: 14px; font-weight: 700; color: var(--settings-text); }
        .setting-desc { font-size: 12px; color: var(--settings-text-muted); }
        .setting-control { justify-self: stretch; display: flex; justify-content: flex-end; align-items: center; gap: var(--settings-space-1); }
        .settings-btn {
            height: var(--settings-control-height); border: none; border-radius: var(--settings-radius);
            background: rgba(255,255,255,0.08); color: var(--settings-text-muted);
            font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.14); color: var(--settings-text); }
        .settings-btn.active { background: var(--settings-accent); color: #05231f; box-shadow: 0 8px 18px rgba(20, 184, 166, 0.3); }
        .segment-wrap { background: rgba(255, 255, 255, 0.05); padding: 4px; border-radius: var(--settings-radius); display: grid; gap: 4px; }
        .segment-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .segment-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .segment-btn {
            height: var(--settings-control-height); border: none; border-radius: calc(var(--settings-radius) - 2px);
            background: transparent; color: var(--settings-text-subtle); font-weight: 700; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 6px; flex-direction: column;
        }
        .segment-btn.active { background: var(--settings-accent-soft); color: var(--settings-text); }
        .segment-btn small { font-size: 10px; line-height: 1; opacity: 0.85; font-weight: 500; }
        .toggle-btn { background: transparent; border: none; padding: 0; cursor: pointer; border-radius: var(--settings-radius); }
        .toggle-track {
            width: 52px; height: 30px; border-radius: 999px; background: rgba(255,255,255,0.16);
            position: relative; transition: all 0.2s ease;
        }
        .toggle-track.on { background: var(--settings-accent); }
        .toggle-thumb {
            width: 22px; height: 22px; border-radius: 999px; background: rgba(255,255,255,0.95);
            position: absolute; top: 4px; left: 4px; transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .toggle-track.on .toggle-thumb { transform: translateX(22px); }
        .toggle-btn:focus-visible { outline: none; box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.28); }
        .settings-input {
            height: var(--settings-control-height); border: none; border-radius: var(--settings-radius);
            background: rgba(255,255,255,0.08); color: var(--settings-text);
            padding: 0 12px; width: 100%; font-size: 14px;
        }
        .settings-input::placeholder { color: rgba(255,255,255,0.45); }
        .settings-input:focus { outline: none; box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.24); }
        .slider-wrap { display: grid; grid-template-columns: 1fr auto; gap: var(--settings-space-1); align-items: center; width: 100%; }
        .slider-value { font-size: 13px; font-weight: 700; color: var(--settings-text-muted); width: 44px; text-align: right; }
        .settings-slider { -webkit-appearance: none; appearance: none; height: 8px; border-radius: 999px; background: rgba(255,255,255,0.16); }
        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 999px;
            background: var(--settings-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.35);
        }
        .settings-slider::-moz-range-thumb {
            width: 20px; height: 20px; border: none; border-radius: 999px; background: var(--settings-accent);
        }

        .app-shell {
            min-height: 100vh;
            background: radial-gradient(circle at 20% -10%, rgba(20, 184, 166, 0.14), transparent 45%), var(--settings-bg);
            color: var(--settings-text);
        }
        .ranking-theme {
            background: radial-gradient(circle at 20% -10%, rgba(250, 204, 21, 0.26), transparent 50%), radial-gradient(circle at 85% 10%, rgba(245, 158, 11, 0.22), transparent 45%), #1f1808;
        }
        .ranking-theme .app-panel { border-color: rgba(250, 204, 21, 0.38); }
        .life-hearts { display: inline-flex; align-items: center; gap: 4px; }
        .life-heart { width: 20px; height: 20px; color: #f43f5e; filter: drop-shadow(0 0 6px rgba(244,63,94,0.35)); }
        .life-heart.empty { color: rgba(255,255,255,0.28); filter: none; }
        .app-panel {
            background: var(--settings-panel);
            border-radius: calc(var(--settings-radius) + 6px);
            border: 1px solid rgba(148, 163, 184, 0.24);
            box-shadow: 0 22px 50px rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(10px);
        }
        .app-overlay {
            background: rgba(5, 10, 18, 0.82);
            backdrop-filter: blur(8px);
        }
        .app-btn-primary,
        .app-btn-secondary,
        .app-btn-danger,
        .app-btn-accent {
            border: 1px solid transparent;
            border-radius: var(--settings-radius);
            font-weight: 700;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .app-btn-primary {
            background: linear-gradient(135deg, #2dd4bf, #0ea5e9);
            color: #032b2c;
            box-shadow: 0 10px 22px rgba(20, 184, 166, 0.3);
        }
        .app-btn-primary:hover { filter: brightness(1.06); }
        .app-btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--settings-text-muted);
            border-color: rgba(148, 163, 184, 0.32);
        }
        .app-btn-secondary:hover { background: rgba(255, 255, 255, 0.14); color: var(--settings-text); }
        .app-btn-danger {
            background: rgba(239, 68, 68, 0.18);
            color: #fecaca;
            border-color: rgba(248, 113, 113, 0.38);
        }
        .app-btn-danger:hover { background: rgba(239, 68, 68, 0.28); }
        .app-btn-accent {
            background: rgba(245, 158, 11, 0.2);
            color: #fde68a;
            border-color: rgba(251, 191, 36, 0.4);
        }
        .app-btn-accent:hover { background: rgba(245, 158, 11, 0.28); }
        .app-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 999px;
            padding: 3px 10px;
            color: var(--settings-text-muted);
        }
        .app-key-btn {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(255, 255, 255, 0.08);
            color: var(--settings-text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }
        .app-key-btn.active {
            background: var(--settings-accent-soft);
            border-color: var(--settings-accent);
            color: var(--settings-text);
            box-shadow: 0 0 16px rgba(20, 184, 166, 0.35);
        }

        /* Layout utilities */
        .block { display: block; }
        .inline-block { display: inline-block; }
        .inline-flex { display: inline-flex; }
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-1 { flex: 1 1 0%; }
        
        .items-center { align-items: center; }
        .items-end { align-items: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-items-center { justify-items: center; }
        
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .col-start-1 { grid-column-start: 1; }
        .row-start-1 { grid-row-start: 1; }
        
        @media (min-width: 640px) {
            .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        
        /* Positioning */
        .static { position: static; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .sticky { position: sticky; }
        
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; }
        .top-1 { top: 0.25rem; }
        .top-4 { top: 1rem; }
        .top-6 { top: 1.5rem; }
        .top-1\/4 { top: 25%; }
        .-top-4 { top: -1rem; }
        .bottom-0 { bottom: 0; }
        .bottom-4 { bottom: 1rem; }
        .left-0 { left: 0; }
        .left-1 { left: 0.25rem; }
        .left-1\/2 { left: 50%; }
        .right-4 { right: 1rem; }
        .right-6 { right: 1.5rem; }
        
        .z-10 { z-index: 10; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        .z-\[60\] { z-index: 60; }
        
        /* Spacing */
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .p-12 { padding: 3rem; }
        
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .px-8 { padding-left: 2rem; padding-right: 2rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .pt-2 { padding-top: 0.5rem; }
        .pt-4 { padding-top: 1rem; }
        .pb-4 { padding-bottom: 1rem; }
        
        .m-0 { margin: 0; }
        .mx-8 { margin-left: 2rem; margin-right: 2rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-12 { margin-top: 3rem; }
        .ml-2 { margin-left: 0.5rem; }
        .ml-\[1px\] { margin-left: 1px; }
        .-mt-\[0\.2em\] { margin-top: -0.2em; }
        
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-y-8 > * + * { margin-top: 2rem; }
        
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        
        /* Sizing */
        .w-5 { width: 1.25rem; }
        .w-12 { width: 3rem; }
        .w-full { width: 100%; }
        .w-\[2px\] { width: 2px; }
        
        .h-1 { height: 0.25rem; }
        .h-2 { height: 0.5rem; }
        .h-5 { height: 1.25rem; }
        .h-7 { height: 1.75rem; }
        .h-24 { height: 6rem; }
        .h-full { height: 100%; }
        .h-\[1em\] { height: 1em; }
        .h-\[80vh\] { height: 80vh; }
        
        .min-h-screen { min-height: 100vh; }
        .min-w-\[1ch\] { min-width: 1ch; }
        .max-w-xs { max-width: 20rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-xl { max-width: 36rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-3xl { max-width: 48rem; }
        .max-w-4xl { max-width: 56rem; }
        .max-h-\[85vh\] { max-height: 85vh; }
        
        /* Typography */
        .font-sans { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .text-5xl { font-size: 3rem; line-height: 1; }
        .text-6xl { font-size: 3.75rem; line-height: 1; }
        .text-\[10px\] { font-size: 10px; }
        
        @media (min-width: 768px) {
            .md\:text-6xl { font-size: 3.75rem; line-height: 1; }
            .md\:text-7xl { font-size: 4.5rem; line-height: 1; }
        }
        
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .font-black { font-weight: 900; }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .uppercase { text-transform: uppercase; }
        .underline { text-decoration: underline; }
        
        .tracking-tighter { letter-spacing: -0.05em; }
        .tracking-wide { letter-spacing: 0.025em; }
        .tracking-wider { letter-spacing: 0.05em; }
        .tracking-widest { letter-spacing: 0.1em; }
        
        .leading-none { line-height: 1; }
        .leading-relaxed { line-height: 1.625; }
        
        .align-middle { vertical-align: middle; }
        
        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre { white-space: pre; }
        .break-all { word-break: break-all; }
        .text-ellipsis { text-overflow: ellipsis; }
        
        /* Colors */
        .text-white { color: rgb(255, 255, 255); }
        .text-slate-200 { color: rgb(226, 232, 240); }
        .text-slate-300 { color: rgb(203, 213, 225); }
        .text-slate-400 { color: rgb(148, 163, 184); }
        .text-slate-500 { color: rgb(100, 116, 139); }
        .text-slate-600 { color: rgb(71, 85, 105); }
        .text-slate-700 { color: rgb(51, 65, 85); }
        .text-cyan-400 { color: rgb(34, 211, 238); }
        .text-cyan-500 { color: rgb(6, 182, 212); }
        .text-indigo-300 { color: rgb(165, 180, 252); }
        .text-indigo-400 { color: rgb(129, 140, 248); }
        .text-red-300 { color: rgb(252, 165, 165); }
        .text-red-400 { color: rgb(248, 113, 113); }
        .text-green-400 { color: rgb(74, 222, 128); }
        .text-yellow-400 { color: rgb(250, 204, 21); }
        .text-transparent { color: transparent; }
        
        .bg-white { background-color: rgb(255, 255, 255); }
        .bg-slate-600 { background-color: rgb(71, 85, 105); }
        .bg-slate-700 { background-color: rgb(51, 65, 85); }
        .bg-slate-800 { background-color: rgb(30, 41, 59); }
        .bg-slate-900 { background-color: rgb(15, 23, 42); }
        .bg-slate-700\/50 { background-color: rgba(51, 65, 85, 0.5); }
        .bg-slate-800\/50 { background-color: rgba(30, 41, 59, 0.5); }
        .bg-slate-900\/50 { background-color: rgba(15, 23, 42, 0.5); }
        .bg-slate-900\/80 { background-color: rgba(15, 23, 42, 0.8); }
        .bg-slate-900\/90 { background-color: rgba(15, 23, 42, 0.9); }
        .bg-slate-900\/95 { background-color: rgba(15, 23, 42, 0.95); }
        .bg-cyan-600 { background-color: rgb(8, 145, 178); }
        .bg-indigo-900 { background-color: rgb(49, 46, 129); }
        .bg-red-900 { background-color: rgb(127, 29, 29); }
        .bg-red-900\/20 { background-color: rgba(127, 29, 29, 0.2); }
        .bg-green-500 { background-color: rgb(34, 197, 94); }
        .bg-green-900\/20 { background-color: rgba(20, 83, 45, 0.2); }
        .bg-yellow-400 { background-color: rgb(250, 204, 21); }
        .bg-yellow-600\/90 { background-color: rgba(202, 138, 4, 0.9); }
        .bg-cyan-500 { background-color: rgb(6, 182, 212); }
        .bg-indigo-500 { background-color: rgb(99, 102, 241); }
        .bg-indigo-500\/20 { background-color: rgba(99, 102, 241, 0.2); }
        .bg-indigo-600 { background-color: rgb(79, 70, 229); }
        .bg-red-500 { background-color: rgb(239, 68, 68); }
        .bg-red-500\/20 { background-color: rgba(239, 68, 68, 0.2); }
        
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-cyan-400 { --tw-gradient-from: rgb(34, 211, 238); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(34, 211, 238, 0)); }
        .to-blue-600 { --tw-gradient-to: rgb(37, 99, 235); }
        .bg-clip-text { -webkit-background-clip: text; background-clip: text; }
        
        .border { border-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-t { border-top-width: 1px; }
        
        .border-slate-600 { border-color: rgb(71, 85, 105); }
        .border-slate-700 { border-color: rgb(51, 65, 85); }
        .border-slate-800 { border-color: rgb(30, 41, 59); }
        .border-slate-600\/50 { border-color: rgba(71, 85, 105, 0.5); }
        .border-slate-700\/50 { border-color: rgba(51, 65, 85, 0.5); }
        .border-indigo-700 { border-color: rgb(67, 56, 202); }
        .border-indigo-900\/50 { border-color: rgba(49, 46, 129, 0.5); }
        .border-red-700 { border-color: rgb(185, 28, 28); }
        .border-green-500\/30 { border-color: rgba(34, 197, 94, 0.3); }
        .border-red-500\/30 { border-color: rgba(239, 68, 68, 0.3); }
        .border-yellow-400\/50 { border-color: rgba(250, 204, 21, 0.5); }
        
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-3xl { border-radius: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded-b-2xl { border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem; }
        
        /* Effects */
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .shadow-\[0_0_20px_rgba\(8\,145\,178\,0\.5\)\] { box-shadow: 0 0 20px rgba(8, 145, 178, 0.5); }
        .shadow-\[0_0_50px_rgba\(0\,0\,0\,0\.3\)\] { box-shadow: 0 0 50px rgba(0, 0, 0, 0.3); }
        .shadow-indigo-900\/20 { box-shadow: 0 20px 25px -5px rgba(49, 46, 129, 0.2), 0 10px 10px -5px rgba(49, 46, 129, 0.2); }
        .drop-shadow-lg { filter: drop-shadow(0 10px 8px rgba(0, 0, 0, 0.04)) drop-shadow(0 4px 3px rgba(0, 0, 0, 0.1)); }
        
        .opacity-0 { opacity: 0; }
        .opacity-80 { opacity: 0.8; }
        
        .backdrop-blur { backdrop-filter: blur(8px); }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        .backdrop-blur-md { backdrop-filter: blur(12px); }
        
        .filter { filter: var(--tw-filter); }
        
        /* Transforms */
        .transform { transform: translateX(var(--tw-translate-x, 0)) translateY(var(--tw-translate-y, 0)) rotate(var(--tw-rotate, 0)) skewX(var(--tw-skew-x, 0)) skewY(var(--tw-skew-y, 0)) scaleX(var(--tw-scale-x, 1)) scaleY(var(--tw-scale-y, 1)); }
        .scale-75 { --tw-scale-x: 0.75; --tw-scale-y: 0.75; transform: scale(0.75); }
        .-translate-x-1\/2 { transform: translateX(-50%); }
        .translate-x-0 { transform: translateX(0); }
        .translate-x-5 { transform: translateX(1.25rem); }
        .origin-right { transform-origin: right; }
        
        /* Transitions */
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-colors { transition-property: color, background-color, border-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-transform { transition-property: transform; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-75 { transition-duration: 75ms; }
        .duration-200 { transition-duration: 200ms; }
        .duration-300 { transition-duration: 300ms; }
        .duration-1000 { transition-duration: 1000ms; }
        .ease-in-out { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        .ease-linear { transition-timing-function: linear; }
        
        /* Interactive */
        .cursor-pointer { cursor: pointer; }
        .select-none { user-select: none; }
        .appearance-none { appearance: none; }
        .pointer-events-none { pointer-events: none; }
        
        .accent-cyan-500 { accent-color: rgb(6, 182, 212); }
        
        /* Overflow */
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        
        /* Hover states */
        .hover\:bg-slate-500:hover { background-color: rgb(100, 116, 139); }
        .hover\:bg-slate-600:hover { background-color: rgb(71, 85, 105); }
        .hover\:bg-slate-700:hover { background-color: rgb(51, 65, 85); }
        .hover\:bg-cyan-500:hover { background-color: rgb(6, 182, 212); }
        .hover\:bg-indigo-500:hover { background-color: rgb(99, 102, 241); }
        .hover\:bg-red-900\/20:hover { background-color: rgba(127, 29, 29, 0.2); }
        .hover\:border-cyan-400:hover { border-color: rgb(34, 211, 238); }
        .hover\:text-white:hover { color: rgb(255, 255, 255); }
        .hover\:text-cyan-300:hover { color: rgb(103, 232, 249); }
        .hover\:text-cyan-400:hover { color: rgb(34, 211, 238); }
        .hover\:text-red-300:hover { color: rgb(252, 165, 165); }
        .hover\:shadow-cyan-500\/25:hover { box-shadow: 0 20px 25px -5px rgba(6, 182, 212, 0.25), 0 10px 10px -5px rgba(6, 182, 212, 0.25); }
        .hover\:shadow-\[0_0_30px_rgba\(34\,211\,238\,0\.6\)\]:hover { box-shadow: 0 0 30px rgba(34, 211, 238, 0.6); }
        
        /* Group hover */
        .group:hover .group-hover\:text-cyan-400 { color: rgb(34, 211, 238); }
    </style>
</head>
<body>
    <script>
        // Inline SVG icons to replace Feather Icons
        window.INLINE_ICONS = {
            'play': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',
            'pause': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',
            'rotate-ccw': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>',
            'settings': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
            'x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            'target': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>',
            'zap': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>',
            'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
            'trophy': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>',
            'bar-chart-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>',
            'keyboard': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"></path></svg>',
            'eye': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
            'eye-off': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>',
            'volume-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>',
            'volume-x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>',
            'trash-2': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
            'log-out': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
            'alert-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
            'book-open': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>',
            'scale': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"></path><path d="M7 21h10"></path><path d="M12 3v18"></path><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"></path></svg>',
            'languages': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"></path><path d="m4 14 6-6 2-3"></path><path d="M2 5h12"></path><path d="M7 2h1"></path><path d="m22 22-5-10-5 10"></path><path d="M14 18h6"></path></svg>',
            'delete': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 5H9l-7 7 7 7h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>',
            'heart': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>'
        };
    </script>
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { WEEKLY_SETTINGS_DOC, normalizeWeeklyRankingSettings, createDefaultWeeklyRankingSettings as getDefaultWeeklyRankingSettings } from "./weekly-settings.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYY4MugI7KvfK4o-UNg4NWLnl5ZVIs6s0",
            authDomain: "typing-ranking-7a3d4.firebaseapp.com",
            projectId: "typing-ranking-7a3d4",
            storageBucket: "typing-ranking-7a3d4.firebasestorage.app",
            messagingSenderId: "141020867565",
            appId: "1:141020867565:web:8e6d9a21a63b63a66e15e4",
            measurementId: "G-86HRZLT1ED"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const authReadyPromise = signInAnonymously(auth).catch((error) => {
            console.error("Failed to sign in anonymously:", error);
            return null;
        });
        const INLINE_ICONS = window.INLINE_ICONS || {};

        const RANKING_MODE_STORAGE_KEY = 'neoTypeRankingNickname';
        const cloneSettings = (settings) => JSON.parse(JSON.stringify(settings));

        // --- Constants: KANA_MAP ---
        const KANA_MAP = {
            'あ': ['a'], 'い': ['i', 'yi'], 'う': ['u', 'wu', 'whu'], 'え': ['e'], 'お': ['o'],
            'か': ['ka', 'ca'], 'き': ['ki'], 'く': ['ku', 'cu', 'qu'], 'け': ['ke'], 'こ': ['ko', 'co'],
            'さ': ['sa'], 'し': ['shi', 'si', 'ci'], 'す': ['su'], 'せ': ['se', 'ce'], 'そ': ['so'],
            'た': ['ta'], 'ち': ['chi', 'ti'], 'つ': ['tsu', 'tu'], 'て': ['te'], 'と': ['to'],
            'な': ['na'], 'に': ['ni'], 'ぬ': ['nu'], 'ね': ['ne'], 'の': ['no'],
            'は': ['ha'], 'ひ': ['hi'], 'ふ': ['fu', 'hu'], 'へ': ['he'], 'ほ': ['ho'],
            'ま': ['ma'], 'み': ['mi'], 'む': ['mu'], 'め': ['me'], 'も': ['mo'],
            'や': ['ya'], 'ゆ': ['yu'], 'よ': ['yo'],
            'ら': ['ra'], 'り': ['ri'], 'る': ['ru'], 'れ': ['re'], 'ろ': ['ro'],
            'わ': ['wa'], 'を': ['wo'], 'ん': ['nn', 'xn', 'n'],
            'が': ['ga'], 'ぎ': ['gi'], 'ぐ': ['gu'], 'げ': ['ge'], 'ご': ['go'],
            'ざ': ['za'], 'じ': ['ji', 'zi'], 'ず': ['zu'], 'ぜ': ['ze'], 'ぞ': ['zo'],
            'だ': ['da'], 'ぢ': ['ji', 'di'], 'づ': ['zu', 'du'], 'で': ['de'], 'ど': ['do'],
            'ば': ['ba'], 'び': ['bi'], 'ぶ': ['bu'], 'べ': ['be'], 'ぼ': ['bo'],
            'ぱ': ['pa'], 'ぴ': ['pi'], 'ぷ': ['pu'], 'ぺ': ['pe'], 'ぽ': ['po'],
            'ぁ': ['xa', 'la'], 'ぃ': ['xi', 'li'], 'ぅ': ['xu', 'lu'], 'ぇ': ['xe', 'le'], 'ぉ': ['xo', 'lo'],
            'ゃ': ['xya', 'lya'], 'ゅ': ['xyu', 'lyu'], 'ょ': ['xyo', 'lyo'], 
            'っ': ['xtu', 'xtsu', 'ltsu', 'ltu'],
            'ー': ['-']
        };

        // --- Constants: COMBO_MAP ---
        const COMBO_MAP = {
            'きゃ': ['kya', 'kicya', 'kixya', 'kilya'], 
            'きゅ': ['kyu', 'kicyu', 'kixyu', 'kilyu'], 
            'きょ': ['kyo', 'kicyo', 'kixyo', 'kilyo'],
            'しゃ': ['sha', 'sya', 'shixya', 'shilya', 'sixya', 'silya', 'cixya', 'cilya'], 
            'しゅ': ['shu', 'syu', 'shixyu', 'shilyu', 'sixyu', 'silyu', 'cixyu', 'cilyu'], 
            'しょ': ['sho', 'syo', 'shixyo', 'shilyo', 'sixyo', 'silyo', 'cixyo', 'cilyo'],
            'ちゃ': ['cha', 'tya', 'cya', 'chixya', 'chilya', 'tixya', 'tilya'], 
            'ちゅ': ['chu', 'tyu', 'cyu', 'chixyu', 'chilyu', 'tixyu', 'tilyu'], 
            'ちょ': ['cho', 'tyo', 'cyo', 'chixyo', 'chilyo', 'tixyo', 'tilyo'],
            'にゃ': ['nya', 'nixya', 'nilya'], 
            'にゅ': ['nyu', 'nixyu', 'nilyu'], 
            'にょ': ['nyo', 'nixyo', 'nilyo'],
            'ひゃ': ['hya', 'hixya', 'hilya'], 
            'ひゅ': ['hyu', 'hixyu', 'hilyu'], 
            'ひょ': ['hyo', 'hixyo', 'hilyo'],
            'みゃ': ['mya', 'mixya', 'milya'], 
            'みゅ': ['myu', 'mixyu', 'milyu'], 
            'みょ': ['myo', 'mixyo', 'milyo'],
            'りゃ': ['rya', 'rixya', 'rilya'], 
            'りゅ': ['ryu', 'rixyu', 'rilyu'], 
            'りょ': ['ryo', 'rixyo', 'rilyo'],
            'ぎゃ': ['gya', 'gixya', 'gilya'], 
            'ぎゅ': ['gyu', 'gixyu', 'gilyu'], 
            'ぎょ': ['gyo', 'gixyo', 'gilyo'],
            'じゃ': ['ja', 'jya', 'zya', 'jixya', 'jilya', 'zixya', 'zilya'], 
            'じゅ': ['ju', 'jyu', 'zyu', 'jixyu', 'jilyu', 'zixyu', 'zilyu'], 
            'じょ': ['jo', 'jyo', 'zyo', 'jixyo', 'jilyo', 'zixyo', 'zilyo'],
            'びゃ': ['bya', 'bixya', 'bilya'], 
            'びゅ': ['byu', 'bixyu', 'bilyu'], 
            'びょ': ['byo', 'bixyo', 'bilyo'],
            'ぴゃ': ['pya', 'pixya', 'pilya'], 
            'ぴゅ': ['pyu', 'pixyu', 'pilyu'], 
            'ぴょ': ['pyo', 'pixyo', 'pilyo'],
            'ふぁ': ['fa', 'fwa', 'fuxa', 'fula', 'huxa', 'hula'], 
            'ふぃ': ['fi', 'fyi', 'fuxi', 'fuli', 'huxi', 'huli'], 
            'ふぇ': ['fe', 'fye', 'fuxe', 'fule', 'huxe', 'hule'], 
            'ふぉ': ['fo', 'fwo', 'fuxo', 'fulo', 'huxo', 'hulo'],
            'ゔ': ['vu'], 'う゛': ['vu'],
            'ゔぁ': ['va', 'vuxa', 'vula'], 
            'ゔぃ': ['vi', 'vuxi', 'vuli'], 
            'ゔぇ': ['ve', 'vuxe', 'vule'], 
            'ゔぉ': ['vo', 'vuxo', 'vulo'],
            'てぃ': ['thi', 'tei', 'texi', 'teli'], 
            'でぃ': ['dhi', 'dei', 'dexi', 'deli'],
            'とぅ': ['twu', 'toxu', 'tolu'],
            'どぅ': ['dwu', 'doxu', 'dolu'],
            'うぃ': ['wi', 'whi', 'uxi', 'uli'], 
            'うぇ': ['we', 'whe', 'uxe', 'ule'], 
            'うぉ': ['who', 'uxo', 'ulo'], 
            'くぁ': ['qa', 'kwa', 'kuxa', 'kula'], 
            'くぃ': ['qi', 'kwi', 'kuxi', 'kuli'], 
            'くぇ': ['qe', 'kwe', 'kuxe', 'kule'], 
            'くぉ': ['qo', 'kwo', 'kuxo', 'kulo'],
            'つぁ': ['tsa', 'tsuxa', 'tsula'], 
            'つぃ': ['tsi', 'tsuxi', 'tsuli'], 
            'つぇ': ['tse', 'tsuxe', 'tsule'], 
            'つぉ': ['tso', 'tsuxo', 'tsulo'],
            'しぇ': ['she', 'sye', 'shixe', 'shile', 'sixe', 'sile'],
            'じぇ': ['je', 'jye', 'jixe', 'jile', 'zixe', 'zile'],
            'ちぇ': ['che', 'tye', 'chixe', 'chile', 'tixe', 'tile']
        };

const INITIAL_WORDS = [
  // --- 街・交通・施設 (Town & Transport) ---
  { text: "信号", kana: "しんごう" },
  { text: "信号機", kana: "しんごうき" },
  { text: "横断歩道", kana: "おうだんほどう" },
  { text: "交差点", kana: "こうさてん" },
  { text: "歩道橋", kana: "ほどうきょう" },
  { text: "自転車", kana: "じてんしゃ" },
  { text: "自動車", kana: "じどうしゃ" },
  { text: "駐車場", kana: "ちゅうしゃじょう" },
  { text: "駐輪場", kana: "ちゅうりんじょう" },
  { text: "郵便局", kana: "ゆうびんきょく" },
  { text: "警察署", kana: "けいさつしょ" },
  { text: "消防署", kana: "しょうぼうしょ" },
  { text: "救急車", kana: "きゅうきゅうしゃ" },
  { text: "消防車", kana: "しょうぼうしゃ" },
  { text: "パトカー", kana: "ぱとかー" },
  { text: "新幹線", kana: "しんかんせん" },
  { text: "飛行機", kana: "ひこうき" },
  { text: "地下鉄", kana: "ちかてつ" },
  { text: "定期券", kana: "ていきけん" },
  { text: "回数券", kana: "かいすうけん" },
  { text: "改札口", kana: "かいさつぐち" },
  { text: "券売機", kana: "けんばいき" },
  { text: "待合室", kana: "まちあいしつ" },
  { text: "停留所", kana: "ていりゅうじょ" },
  { text: "時刻表", kana: "じこくひょう" },
  { text: "始発列車", kana: "しはつれっしゃ" },
  { text: "終電", kana: "しゅうでん" },
  { text: "満員電車", kana: "まんいんでんしゃ" },
  { text: "優先席", kana: "ゆうせんせき" },
  { text: "運転免許証", kana: "うんてんめんきょしょう" },
  { text: "図書館", kana: "としょかん" },
  { text: "水族館", kana: "すいぞくかん" },
  { text: "博物館", kana: "はくぶつかん" },
  { text: "美術館", kana: "びじゅつかん" },
  { text: "映画館", kana: "えいがかん" },
  { text: "遊園地", kana: "ゆうえんち" },
  { text: "動物園", kana: "どうぶつえん" },
  { text: "植物園", kana: "しょくぶつえん" },
  { text: "市役所", kana: "しやくしょ" },
  { text: "銀行", kana: "ぎんこう" },
  { text: "病院", kana: "びょういん" },
  { text: "薬局", kana: "やっきょく" },
  { text: "美容院", kana: "びよういん" },
  { text: "理髪店", kana: "りはつてん" },
  { text: "コンビニ", kana: "こんびに" },
  { text: "スーパー", kana: "すーぱー" },
  { text: "商店街", kana: "しょうてんがい" },
  { text: "百貨店", kana: "ひゃっかてん" },
  { text: "自動販売機", kana: "じどうはんばいき" },
  { text: "公衆電話", kana: "こうしゅうでんわ" },
  { text: "電信柱", kana: "でんしんばしら" },
  { text: "掲示板", kana: "けいじばん" },
  { text: "案内所", kana: "あんないじょ" },
  { text: "非常口", kana: "ひじょうぐち" },
  { text: "消火器", kana: "しょうかき" },
  
  // --- 学校・教育 (School) ---
  { text: "小学校", kana: "しょうがっこう" },
  { text: "中学校", kana: "ちゅうがっこう" },
  { text: "高等学校", kana: "こうとうがっこう" },
  { text: "大学院", kana: "だいがくいん" },
  { text: "専門学校", kana: "せんもんがっこう" },
  { text: "幼稚園", kana: "ようちえん" },
  { text: "保育園", kana: "ほいくえん" },
  { text: "入学式", kana: "にゅうがくしき" },
  { text: "卒業式", kana: "そつぎょうしき" },
  { text: "始業式", kana: "しぎょうしき" },
  { text: "終業式", kana: "しゅうぎょうしき" },
  { text: "運動会", kana: "うんどうかい" },
  { text: "体育祭", kana: "たいいくさい" },
  { text: "文化祭", kana: "ぶんかさい" },
  { text: "修学旅行", kana: "しゅうがくりょこう" },
  { text: "遠足", kana: "えんそく" },
  { text: "夏休み", kana: "なつやすみ" },
  { text: "冬休み", kana: "ふゆやすみ" },
  { text: "春休み", kana: "はるやすみ" },
  { text: "通知表", kana: "つうちひょう" },
  { text: "成績表", kana: "せいせきひょう" },
  { text: "時間割", kana: "じかんわり" },
  { text: "教科書", kana: "きょうかしょ" },
  { text: "参考書", kana: "さんこうしょ" },
  { text: "問題集", kana: "もんだいしゅう" },
  { text: "単語帳", kana: "たんごちょう" },
  { text: "筆記用具", kana: "ひっきようぐ" },
  { text: "鉛筆削り", kana: "えんぴつけずり" },
  { text: "消しゴム", kana: "けしごむ" },
  { text: "黒板消し", kana: "こくばんけし" },
  { text: "定規", kana: "じょうぎ" },
  { text: "分度器", kana: "ぶんどき" },
  { text: "給食当番", kana: "きゅうしょくとうばん" },
  { text: "掃除当番", kana: "そうじとうばん" },
  { text: "日直", kana: "にっちょく" },
  { text: "委員会", kana: "いいんかい" },
  { text: "生徒会", kana: "せいとかい" },
  { text: "部活動", kana: "ぶかつどう" },
  { text: "職員室", kana: "しょくいんしつ" },
  { text: "保健室", kana: "ほけんしつ" },
  { text: "図書室", kana: "としょしつ" },
  { text: "音楽室", kana: "おんがくしつ" },
  { text: "理科室", kana: "りかしつ" },
  { text: "家庭科", kana: "かていか" },
  { text: "算数", kana: "さんすう" },
  { text: "数学", kana: "すうがく" },
  { text: "社会科", kana: "しゃかいか" },
  { text: "歴史", kana: "れきし" },
  { text: "地理", kana: "ちり" },
  { text: "公民", kana: "こうみん" },
  { text: "物理", kana: "ぶつり" },
  { text: "化学", kana: "かがく" },
  { text: "生物", kana: "せいぶつ" },
  { text: "地学", kana: "ちがく" },
  { text: "美術", kana: "びじゅつ" },
  { text: "技術", kana: "ぎじゅつ" },

  // --- 家庭・生活・道具 (Home & Life) ---
  { text: "冷蔵庫", kana: "れいぞうこ" },
  { text: "洗濯機", kana: "せんたくき" },
  { text: "掃除機", kana: "そうじき" },
  { text: "炊飯器", kana: "すいはんき" },
  { text: "電子レンジ", kana: "でんしれんじ" },
  { text: "扇風機", kana: "せんぷうき" },
  { text: "換気扇", kana: "かんきせん" },
  { text: "空気清浄機", kana: "くうきせいじょうき" },
  { text: "加湿器", kana: "かしつき" },
  { text: "除湿機", kana: "じょしつき" },
  { text: "暖房器具", kana: "だんぼうきぐ" },
  { text: "給湯器", kana: "きゅうとうき" },
  { text: "食器洗い機", kana: "しょっきあらいき" },
  { text: "乾燥機", kana: "かんそうき" },
  { text: "延長コード", kana: "えんちょうこーど" },
  { text: "充電器", kana: "じゅうでんき" },
  { text: "乾電池", kana: "かんでんち" },
  { text: "懐中電灯", kana: "かいちゅうでんとう" },
  { text: "爪切り", kana: "つめきり" },
  { text: "耳かき", kana: "みみかき" },
  { text: "体温計", kana: "たいおんけい" },
  { text: "絆創膏", kana: "ばんそうこう" },
  { text: "湿布薬", kana: "しっぷやく" },
  { text: "目薬", kana: "めぐすり" },
  { text: "歯ブラシ", kana: "はぶらし" },
  { text: "歯磨き粉", kana: "はみがきこ" },
  { text: "洗面所", kana: "せんめんじょ" },
  { text: "お風呂場", kana: "おふろば" },
  { text: "脱衣所", kana: "だついじょ" },
  { text: "寝室", kana: "しんしつ" },
  { text: "居間", kana: "いま" },
  { text: "台所", kana: "だいどころ" },
  { text: "玄関", kana: "げんかん" },
  { text: "郵便受け", kana: "ゆうびんうけ" },
  { text: "宅配便", kana: "たくはいびん" },
  { text: "再配達", kana: "さいはいたつ" },
  { text: "不在票", kana: "ふざいひょう" },
  { text: "請求書", kana: "せいきゅうしょ" },
  { text: "領収書", kana: "りょうしゅうしょ" },
  { text: "取扱説明書", kana: "とりあつかいせつめいしょ" },
  { text: "保証書", kana: "ほしょうしょ" },
  { text: "印鑑証明", kana: "いんかんしょうめい" },
  { text: "住民票", kana: "じゅうみんひょう" },
  { text: "戸籍謄本", kana: "こせきとうほん" },
  { text: "年金手帳", kana: "ねんきんてちょう" },
  { text: "保険証", kana: "ほけんしょう" },
  { text: "診察券", kana: "しんさつけん" },
  { text: "会員証", kana: "かいいんしょう" },
  { text: "ポイントカード", kana: "ぽいんとかーど" },
  { text: "クレジットカード", kana: "くれじっとかーど" },
  { text: "通帳", kana: "つうちょう" },

  // --- 自然・気象・宇宙 (Nature & Weather) ---
  { text: "天気予報", kana: "てんきよほう" },
  { text: "降水確率", kana: "こうすいかくりつ" },
  { text: "最高気温", kana: "さいこうきおん" },
  { text: "最低気温", kana: "さいていきおん" },
  { text: "湿度", kana: "しつど" },
  { text: "気圧", kana: "きあつ" },
  { text: "高気圧", kana: "こうきあつ" },
  { text: "低気圧", kana: "ていきあつ" },
  { text: "台風", kana: "たいふう" },
  { text: "熱帯低気圧", kana: "ねったいていきあつ" },
  { text: "集中豪雨", kana: "しゅうちゅうごうう" },
  { text: "ゲリラ豪雨", kana: "げりらごうう" },
  { text: "土砂降り", kana: "どしゃぶり" },
  { text: "梅雨前線", kana: "ばいうぜんせん" },
  { text: "秋雨前線", kana: "あきさめぜんせん" },
  { text: "異常気象", kana: "いじょうきしょう" },
  { text: "地球温暖化", kana: "ちきゅうおんだんか" },
  { text: "温室効果ガス", kana: "おんしつこうかがす" },
  { text: "二酸化炭素", kana: "にさんかたんそ" },
  { text: "酸素", kana: "さんそ" },
  { text: "水素", kana: "すいそ" },
  { text: "窒素", kana: "ちっそ" },
  { text: "オゾン層", kana: "おぞんそう" },
  { text: "紫外線", kana: "しがいせん" },
  { text: "赤外線", kana: "せきがいせん" },
  { text: "放射能", kana: "ほうしゃのう" },
  { text: "太陽系", kana: "たいようけい" },
  { text: "水金地火木土天海", kana: "すいきんちかもくどってんかい" },
  { text: "小惑星", kana: "しょうわくせい" },
  { text: "彗星", kana: "すいせい" },
  { text: "流星群", kana: "りゅうせいぐん" },
  { text: "天の川", kana: "あまのがわ" },
  { text: "ブラックホール", kana: "ぶらっくほーる" },
  { text: "超新星爆発", kana: "ちょうしんせいばくはつ" },
  { text: "宇宙飛行士", kana: "うちゅうひこうし" },
  { text: "国際宇宙ステーション", kana: "こくさいうちゅうすてーしょん" },
  { text: "人工衛星", kana: "じんこうえいせい" },
  { text: "太平洋", kana: "たいへいよう" },
  { text: "大西洋", kana: "たいせいよう" },
  { text: "インド洋", kana: "いんどよう" },
  { text: "北極海", kana: "ほっきょくかい" },
  { text: "南極大陸", kana: "なんきょくたいりく" },
  { text: "エベレスト", kana: "えべれすと" },
  { text: "富士山", kana: "ふじさん" },
  { text: "活火山", kana: "かつかざん" },
  { text: "休火山", kana: "きゅうかざん" },
  { text: "震度", kana: "しんど" },
  { text: "マグニチュード", kana: "まぐにちゅーど" },
  { text: "津波", kana: "つなみ" },
  { text: "避難所", kana: "ひなんじょ" },

  // --- 体・健康・医療 (Body & Health) ---
  { text: "健康診断", kana: "けんこうしんだん" },
  { text: "予防接種", kana: "よぼうせっしゅ" },
  { text: "内科検診", kana: "ないかけんしん" },
  { text: "歯科検診", kana: "しかけんしん" },
  { text: "視力検査", kana: "しりょくけんさ" },
  { text: "聴力検査", kana: "ちょうりょくけんさ" },
  { text: "血液検査", kana: "けつえきけんさ" },
  { text: "レントゲン", kana: "れんとげん" },
  { text: "心電図", kana: "しんでんず" },
  { text: "処方箋", kana: "しょほうせん" },
  { text: "抗生物質", kana: "こうせいぶっしつ" },
  { text: "鎮痛剤", kana: "ちんつうざい" },
  { text: "解熱剤", kana: "げねつざい" },
  { text: "胃腸薬", kana: "いちょうやく" },
  { text: "目薬", kana: "めぐすり" },
  { text: "副作用", kana: "ふくさよう" },
  { text: "後遺症", kana: "こういしょう" },
  { text: "筋肉痛", kana: "きんにくつう" },
  { text: "骨折", kana: "こっせつ" },
  { text: "捻挫", kana: "ねんざ" },
  { text: "打撲", kana: "だぼく" },
  { text: "脱臼", kana: "だっきゅう" },
  { text: "擦り傷", kana: "すりきず" },
  { text: "切り傷", kana: "きりきず" },
  { text: "火傷", kana: "やけど" },
  { text: "花粉症", kana: "かふんしょう" },
  { text: "熱中症", kana: "ねっちゅうしょう" },
  { text: "脱水症状", kana: "だっすいしょうじょう" },
  { text: "インフルエンザ", kana: "いんふるえんざ" },
  { text: "ウイルス", kana: "ういるす" },
  { text: "細菌", kana: "さいきん" },
  { text: "免疫力", kana: "めんえきりょく" },
  { text: "新陳代謝", kana: "しんちんたいしゃ" },
  { text: "有酸素運動", kana: "ゆうさんそうんどう" },
  { text: "筋力トレーニング", kana: "きんりょくとれーにんぐ" },
  { text: "ストレッチ", kana: "すとれっち" },
  { text: "深呼吸", kana: "しんこきゅう" },
  { text: "睡眠不足", kana: "すいみんぶそく" },
  { text: "栄養バランス", kana: "えいようばらんす" },
  { text: "炭水化物", kana: "たんすいかぶつ" },
  { text: "タンパク質", kana: "たんぱくしつ" },
  { text: "脂質", kana: "ししつ" },
  { text: "食物繊維", kana: "しょくもつせんい" },
  { text: "膠原病", kana: "こうげんびょう" },
  { text: "糖尿病", kana: "とうにょうびょう" },
  { text: "高血圧", kana: "こうけつあつ" },

  // --- 感情・形容・表現 (Emotion & Expression) ---
  { text: "一生懸命", kana: "いっしょうけんめい" },
  { text: "誠心誠意", kana: "せいしんせいい" },
  { text: "無我夢中", kana: "むがむちゅう" },
  { text: "興味津々", kana: "きょうみしんしん" },
  { text: "支離滅裂", kana: "しりめつれつ" },
  { text: "優柔不断", kana: "ゆうじゅうふだん" },
  { text: "有言実行", kana: "ゆうげんじっこう" },
  { text: "不言実行", kana: "ふげんじっこう" },
  { text: "臨機応変", kana: "りんきおうへん" },
  { text: "自画自賛", kana: "じがじさん" },
  { text: "油断大敵", kana: "ゆだんたいてき" },
  { text: "一石二鳥", kana: "いっせきにちょう" },
  { text: "一長一短", kana: "いっちょういったん" },
  { text: "試行錯誤", kana: "しこうさくご" },
  { text: "自業自得", kana: "じごうじとく" },
  { text: "以心伝心", kana: "いしんでんしん" },
  { text: "波乱万丈", kana: "はらんばんじょう" },
  { text: "喜怒哀楽", kana: "きどあいらく" },
  { text: "整理整頓", kana: "せいりせいとん" },
  { text: "質実剛健", kana: "しつじつごうけん" },
  { text: "温故知新", kana: "おんこちしん" },
  { text: "切磋琢磨", kana: "せっさたくま" },
  { text: "粉骨砕身", kana: "ふんこつさいしん" },
  { text: "日進月歩", kana: "にっしんげっぽ" },
  { text: "千載一遇", kana: "せんざいいちぐう" },
  { text: "起死回生", kana: "きしかいせい" },
  { text: "意気投合", kana: "いきとうごう" },
  { text: "唯我独尊", kana: "ゆいがどくそん" },
  { text: "四面楚歌", kana: "しめんそか" },
  { text: "五里霧中", kana: "ごりむちゅう" },
  { text: "半信半疑", kana: "はんしんはんぎ" },
  { text: "自暴自棄", kana: "じぼうじき" },
  { text: "前代未聞", kana: "ぜんだいみもん" },
  { text: "絶体絶命", kana: "ぜったいぜつめい" },
  { text: "危機一髪", kana: "ききいっぱつ" },
  { text: "創意工夫", kana: "そういくふう" },
  { text: "適材適所", kana: "てきざいてきしょ" },
  { text: "老若男女", kana: "ろうにゃくなんにょ" },
  { text: "東西南北", kana: "とうざいなんぼく" },
  { text: "春夏秋冬", kana: "しゅんかしゅうとう" },
  { text: "花鳥風月", kana: "かちょうふうげつ" },
  { text: "焼肉定食", kana: "やきにくていしょく" },
  { text: "大盛無料", kana: "おおもりむりょう" },
  { text: "期間限定", kana: "きかんげんてい" },
  { text: "数量限定", kana: "すうりょうげんてい" },
  { text: "本日休業", kana: "ほんじつきゅうぎょう" },
  { text: "準備中", kana: "じゅんびちゅう" },
  { text: "営業中", kana: "えいぎょうちゅう" },

  // --- カタカナ語・その他 (Katakana & Misc) ---
  { text: "インターネット", kana: "いんたーねっと" },
  { text: "コミュニケーション", kana: "こみゅにけーしょん" },
  { text: "シミュレーション", kana: "しみゅれーしょん" },
  { text: "イノベーション", kana: "いのべーしょん" },
  { text: "モチベーション", kana: "もちべーしょん" },
  { text: "プレゼンテーション", kana: "ぷれぜんてーしょん" },
  { text: "ディスカッション", kana: "でぃすかっしょん" },
  { text: "ブレインストーミング", kana: "ぶれいんすとーみんぐ" },
  { text: "コンプライアンス", kana: "こんぷらいあんす" },
  { text: "サステナビリティ", kana: "さすてなびりてぃ" },
  { text: "ダイバーシティ", kana: "だいばーしてぃ" },
  { text: "グローバル", kana: "ぐろーばる" },
  { text: "スタンダード", kana: "すたんだーど" },
  { text: "パフォーマンス", kana: "ぱふぉーまんす" },
  { text: "コストパフォーマンス", kana: "こすとぱふぉーまんす" },
  { text: "タイムパフォーマンス", kana: "たいむぱふぉーまんす" },
  { text: "コンビニエンスストア", kana: "こんびにえんすすとあ" },
  { text: "スーパーマーケット", kana: "すーぱーまーけっと" },
  { text: "ショッピングモール", kana: "しょっぴんぐもーる" },
  { text: "テーマパーク", kana: "てーまぱーく" },
  { text: "アミューズメント", kana: "あみゅーずめんと" },
  { text: "エスカレーター", kana: "えすかれーたー" },
  { text: "エレベーター", kana: "えれべーたー" },
  { text: "コインランドリー", kana: "こいんらんどりー" },
  { text: "クリーニング", kana: "くりーにんぐ" },
  { text: "リサイクルショップ", kana: "りさいくるしょっぷ" },
  { text: "フリーマーケット", kana: "ふりーまーけっと" },
  { text: "ボランティア", kana: "ぼらんてぃあ" },
  { text: "リノベーション", kana: "りのべーしょん" },
  { text: "コンチェルト", kana: "こんちぇると" },
  { text: "クァルテット", kana: "くぁるてっと" },
  { text: "ウィザード", kana: "うぃざーど" },
  { text: "ヴォルケーノ", kana: "ゔぉるけーの" },

  // --- 追加: 長音強化 (Long Vowels) ---
  { text: "スーパーカー", kana: "すーぱーかー" },
  { text: "ハンバーガー", kana: "はんばーがー" },
  { text: "コンピューター", kana: "こんぴゅーたー" },
  { text: "パスポート", kana: "ぱすぽーと" },
  { text: "カレンダー", kana: "かれんだー" },
  { text: "エネルギー", kana: "えねるぎー" },
  { text: "タクシー", kana: "たくしー" },
  { text: "リポーター", kana: "りぽーたー" },
  { text: "マフラー", kana: "まふらー" },
  { text: "セーター", kana: "せーたー" },
  { text: "スニーカー", kana: "すにーかー" },
  { text: "ストーブ", kana: "すとーぶ" },

  // --- 追加: P音強化 (P Sounds) ---
  { text: "ピアノ", kana: "ぴあの" },
  { text: "プレゼント", kana: "ぷれぜんと" },
  { text: "プロテイン", kana: "ぷろていん" },
  { text: "ピンク", kana: "ぴんく" },
  { text: "プラスチック", kana: "ぷらすちっく" },
  { text: "プラネタリウム", kana: "ぷらねたりうむ" },
  { text: "パラダイス", kana: "ぱらだいす" },
  { text: "ピクニック", kana: "ぴくにっく" },
  { text: "パイロット", kana: "ぱいろっと" },
  { text: "ポケット", kana: "ぽけっと" },
  { text: "ページ", kana: "ぺーじ" },
  { text: "プロペラ", kana: "ぷろぺら" },
  { text: "ペガサス", kana: "ぺがさす" }
];

// --- 法律用語リスト (Legal Terms) ---
const LEGAL_WORDS = [
  // --- 民法 (Civil Law) ---
  { text: "善意", kana: "ぜんい" },
  { text: "悪意", kana: "あくい" },
  { text: "過失", kana: "かしつ" },
  { text: "重過失", kana: "じゅうかしつ" },
  { text: "故意", kana: "こい" },
  { text: "錯誤", kana: "さくご" },
  { text: "詐欺", kana: "さぎ" },
  { text: "強迫", kana: "きょうはく" },
  { text: "心裡留保", kana: "しんりりゅうほ" },
  { text: "虚偽表示", kana: "きょぎひょうじ" },
  { text: "無権代理", kana: "むけんだいり" },
  { text: "表見代理", kana: "ひょうけんだいり" },
  { text: "時効", kana: "じこう" },
  { text: "取得時効", kana: "しゅとくじこう" },
  { text: "消滅時効", kana: "しょうめつじこう" },
  { text: "物権", kana: "ぶっけん" },
  { text: "債権", kana: "さいけん" },
  { text: "所有権", kana: "しょゆうけん" },
  { text: "占有権", kana: "せんゆうけん" },
  { text: "即時取得", kana: "そくじしゅとく" },
  { text: "地上権", kana: "ちじょうけん" },
  { text: "永小作権", kana: "えいこさくけん" },
  { text: "地役権", kana: "ちえきけん" },
  { text: "留置権", kana: "りゅうちけん" },
  { text: "先取特権", kana: "さきどりとっけん" },
  { text: "質権", kana: "しちけん" },
  { text: "抵当権", kana: "ていとうけん" },
  { text: "根抵当権", kana: "ねていとうけん" },
  { text: "債務不履行", kana: "さいむふりこう" },
  { text: "履行遅滞", kana: "りこうちたい" },
  { text: "履行不能", kana: "りこうふのう" },
  { text: "損害賠償", kana: "そんがいばいしょう" },
  { text: "解除", kana: "かいじょ" },
  { text: "連帯債務", kana: "れんたいさいむ" },
  { text: "保証債務", kana: "ほしょうさいむ" },
  { text: "債権譲渡", kana: "さいけんじょうと" },
  { text: "弁済", kana: "べんさい" },
  { text: "代物弁済", kana: "だいぶつべんさい" },
  { text: "相殺", kana: "そうさい" },
  { text: "更改", kana: "こうかい" },
  { text: "免除", kana: "めんじょ" },
  { text: "混同", kana: "こんどう" },
  { text: "契約", kana: "けいやく" },
  { text: "贈与", kana: "ぞうよ" },
  { text: "売買", kana: "ばいばい" },
  { text: "交換", kana: "こうかん" },
  { text: "消費貸借", kana: "しょうひたいしゃく" },
  { text: "使用貸借", kana: "しようたいしゃく" },
  { text: "賃貸借", kana: "ちんたいしゃく" },
  { text: "雇用", kana: "こよう" },
  { text: "請負", kana: "うけおい" },
  { text: "委任", kana: "いにん" },
  { text: "寄託", kana: "きたく" },
  { text: "組合", kana: "くみあい" },
  { text: "和解", kana: "わかい" },
  { text: "事務管理", kana: "じむかんり" },
  { text: "不当利得", kana: "ふとうりとく" },
  { text: "不法行為", kana: "ふほうこうい" },
  { text: "親族", kana: "しんぞく" },
  { text: "婚姻", kana: "こんいん" },
  { text: "離婚", kana: "りこん" },
  { text: "親権", kana: "しんけん" },
  { text: "成年後見", kana: "せいねんこうけん" },
  { text: "扶養", kana: "ふよう" },
  { text: "相続", kana: "そうぞく" },
  { text: "遺言", kana: "いごん" },
  { text: "遺留分", kana: "いりゅうぶん" },
  { text: "登記", kana: "とうき" },
  { text: "対抗要件", kana: "たいこうようけん" },
  { text: "権利能力", kana: "けんりのうりょく" },
  { text: "意思能力", kana: "いしのうりょく" },
  { text: "行為能力", kana: "こういのうりょく" },

  // --- 刑法 (Criminal Law) ---
  { text: "罪刑法定主義", kana: "ざいけいほうていしゅぎ" },
  { text: "構成要件", kana: "こうせいようけん" },
  { text: "違法性", kana: "いほうせい" },
  { text: "責任", kana: "せきにん" },
  { text: "作為", kana: "さくい" },
  { text: "不作為", kana: "ふさくい" },
  { text: "因果関係", kana: "いんがかんけい" },
  { text: "正当防衛", kana: "せいとうぼうえい" },
  { text: "緊急避難", kana: "きんきゅうひなん" },
  { text: "責任能力", kana: "せきにんのうりょく" },
  { text: "心神喪失", kana: "しんしんそうしつ" },
  { text: "心神耗弱", kana: "しんしんこうじゃく" },
  { text: "未遂", kana: "みすい" },
  { text: "不能犯", kana: "ふのうはん" },
  { text: "中止犯", kana: "ちゅうしはん" },
  { text: "予備", kana: "よび" },
  { text: "共犯", kana: "きょうはん" },
  { text: "共同正犯", kana: "きょうどうせいはん" },
  { text: "教唆犯", kana: "きょうさはん" },
  { text: "幇助犯", kana: "ほうじょはん" },
  { text: "間接正犯", kana: "かんせつせいはん" },
  { text: "併合罪", kana: "へいごうざい" },
  { text: "執行猶予", kana: "しっこうゆうよ" },
  { text: "仮釈放", kana: "かりしゃくほう" },
  { text: "時効", kana: "じこう" },
  { text: "殺人", kana: "さつじん" },
  { text: "傷害", kana: "しょうがい" },
  { text: "暴行", kana: "ぼうこう" },
  { text: "脅迫", kana: "きょうはく" },
  { text: "監禁", kana: "かんきん" },
  { text: "誘拐", kana: "ゆうかい" },
  { text: "名誉毀損", kana: "めいよきそん" },
  { text: "信用毀損", kana: "しんようきそん" },
  { text: "業務妨害", kana: "ぎょうむぼうがい" },
  { text: "窃盗", kana: "せっとう" },
  { text: "強盗", kana: "ごうとう" },
  { text: "横領", kana: "おうりょう" },
  { text: "背任", kana: "はいにん" },
  { text: "恐喝", kana: "きょうかつ" },
  { text: "放火", kana: "ほうか" },
  { text: "偽造", kana: "ぎぞう" },
  { text: "賭博", kana: "とばく" },
  { text: "贈収賄", kana: "ぞうしゅうわい" },
  { text: "公務執行妨害", kana: "こうむしっこうぼうがい" },

  // --- 憲法 (Constitution) ---
  { text: "国民主権", kana: "こくみんしゅけん" },
  { text: "基本的人権", kana: "きほんてきじんけん" },
  { text: "平和主義", kana: "へいわしゅぎ" },
  { text: "法の下の平等", kana: "ほうのもとのびょうどう" },
  { text: "思想良心の自由", kana: "しそうりょうしんのじゆう" },
  { text: "信教の自由", kana: "しんきょうのじゆう" },
  { text: "政教分離", kana: "せいきょうぶんり" },
  { text: "表現の自由", kana: "ひょうげんのじゆう" },
  { text: "検閲", kana: "けんえつ" },
  { text: "通信の秘密", kana: "つうしんのひみつ" },
  { text: "学問の自由", kana: "がくもんのじゆう" },
  { text: "生存権", kana: "せいぞんけん" },
  { text: "教育を受ける権利", kana: "きょういくをうけるけんり" },
  { text: "勤労の権利", kana: "きんろうのけんり" },
  { text: "労働三権", kana: "ろうどうさんけん" },
  { text: "適正手続", kana: "てきせいてつづき" },
  { text: "冤罪", kana: "えんざい" },
  { text: "国会", kana: "こっかい" },
  { text: "内閣", kana: "ないかく" },
  { text: "裁判所", kana: "さいばんしょ" },
  { text: "違憲審査権", kana: "いけんしんさけん" },
  { text: "地方自治", kana: "ちほうじち" },
  { text: "象徴天皇制", kana: "しょうちょうてんのうせい" },
  { text: "憲法改正", kana: "けんぽうかいせい" },
  { text: "国民投票", kana: "こくみんとうひょう" },

  // --- 訴訟法 (Procedural Law) ---
  { text: "民事訴訟", kana: "みんじそしょう" },
  { text: "刑事訴訟", kana: "けいじそしょう" },
  { text: "管轄", kana: "かんかつ" },
  { text: "当事者", kana: "とうじしゃ" },
  { text: "原告", kana: "げんこく" },
  { text: "被告", kana: "ひこく" },
  { text: "訴えの利益", kana: "うったえのりえき" },
  { text: "口頭弁論", kana: "こうとうべんろん" },
  { text: "証拠", kana: "しょうこ" },
  { text: "証明責任", kana: "しょうめいせきにん" },
  { text: "自由心証主義", kana: "じゆうしんしょうしゅぎ" },
  { text: "弁論主義", kana: "べんろんしゅぎ" },
  { text: "処分権主義", kana: "しょぶんけんしゅぎ" },
  { text: "判決", kana: "はんけつ" },
  { text: "既判力", kana: "きはんりょく" },
  { text: "控訴", kana: "こうそ" },
  { text: "上告", kana: "じょうこく" },
  { text: "再審", kana: "さいしん" },
  { text: "強制執行", kana: "きょうせいしっこう" },
  { text: "保全処分", kana: "ほぜんしょぶん" },
  { text: "仮差押え", kana: "かりさしおさえ" },
  { text: "仮処分", kana: "かりしょぶん" },
  { text: "被疑者", kana: "ひぎしゃ" },
  { text: "被告人", kana: "ひこくにん" },
  { text: "令状", kana: "れいじょう" },
  { text: "逮捕", kana: "たいほ" },
  { text: "勾留", kana: "こうりゅう" },
  { text: "保釈", kana: "ほしゃく" },
  { text: "公判", kana: "こうはん" },
  { text: "起訴", kana: "きそ" },
  { text: "不起訴", kana: "ふきそ" },
  { text: "自白", kana: "じはく" },
  { text: "黙秘権", kana: "もくひけん" },
  { text: "推定無罪", kana: "すいていむざい" },
  { text: "証人尋問", kana: "しょうにんじんもん" },

  // --- 商法・会社法 (Commercial/Company Law) ---
  { text: "商人", kana: "しょうにん" },
  { text: "商行為", kana: "しょうこうい" },
  { text: "株式会社", kana: "かぶしきがいしゃ" },
  { text: "発起人", kana: "ほっきにん" },
  { text: "定款", kana: "ていかん" },
  { text: "株式", kana: "かぶしき" },
  { text: "株主総会", kana: "かぶぬしそうかい" },
  { text: "取締役", kana: "とりしまりやく" },
  { text: "監査役", kana: "かんさやく" },
  { text: "代表取締役", kana: "だいひょうとりしまりやく" },
  { text: "善管注意義務", kana: "ぜんかんちゅういぎむ" },
  { text: "忠実義務", kana: "ちゅうじつぎむ" },
  { text: "株主代表訴訟", kana: "かぶぬしだいひょうそしょう" },
  { text: "新株予約権", kana: "しんかぶよやくけん" },
  { text: "社債", kana: "しゃさい" },
  { text: "合併", kana: "がっぺい" },
  { text: "会社分割", kana: "かいしゃぶんかつ" },
  { text: "事業譲渡", kana: "じぎょうじょうと" },
  { text: "手形", kana: "てがた" },
  { text: "小切手", kana: "こぎって" },
  { text: "裏書", kana: "うらがき" },

  // --- その他・法学一般 (General Legal) ---
  { text: "六法全書", kana: "ろっぽうぜんしょ" },
  { text: "判例", kana: "はんれい" },
  { text: "裁判官", kana: "さいばんかん" },
  { text: "検察官", kana: "けんさつかん" },
  { text: "弁護士", kana: "べんごし" },
  { text: "司法書士", kana: "しほうしょし" },
  { text: "行政書士", kana: "ぎょうせいしょし" },
  { text: "通説", kana: "つうせつ" },
  { text: "有力説", kana: "ゆうりょくせつ" },
  { text: "少数説", kana: "しょうすうせつ" },
  { text: "条文", kana: "じょうぶん" },
  { text: "公布", kana: "こうふ" },
  { text: "施行", kana: "しこう" },
  { text: "解釈", kana: "かいしゃく" },
  { text: "適用", kana: "てきよう" },
  { text: "準用", kana: "じゅんよう" },
  { text: "類推適用", kana: "るいすいてきよう" },
  { text: "反対解釈", kana: "はんたいかいしゃく" },
  { text: "公序良俗", kana: "こうじょりょうぞく" },
  { text: "信義誠実の原則", kana: "しんぎせいじつのげんそく" },
  { text: "権利の濫用", kana: "けんりのらんよう" }
];

        const KEYBOARD_LAYOUT = [
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', '-'],
            ['z', 'x', 'c', 'v', 'b', 'n', 'm']
        ];

        // --- Utility Functions ---
        const getNodeConsonant = (char, nextChar) => {
            if (!char) return null;
            const combo = char + (nextChar || '');
            if (COMBO_MAP[combo]) return COMBO_MAP[combo][0][0];
            if (KANA_MAP[char]) return KANA_MAP[char][0][0];
            return null;
        };

        const parseKana = (kana) => {
            const nodes = [];
            let i = 0;
            while (i < kana.length) {
                let char = kana[i];
                let nextChar = kana[i + 1];
                let combo = char + (nextChar || '');
                let options = [];
                let isCombo = false;
                let isSokuon = (char === 'っ');

                if (nextChar && COMBO_MAP[combo]) {
                    options = [...COMBO_MAP[combo]];
                    isCombo = true;
                } else if (isSokuon) {
                    options = KANA_MAP['っ'];
                } else {
                    options = KANA_MAP[char] ? [...KANA_MAP[char]] : [char];
                }

                let defaultDisplay = options[0];
                if (isSokuon && !isCombo && i + 1 < kana.length) {
                    const nextCon = getNodeConsonant(kana[i+1], kana[i+2]);
                    if (nextCon) {
                        defaultDisplay = nextCon;
                    }
                }

                nodes.push({
                    char: isCombo ? combo : char,
                    options: options,
                    input: '',
                    selectedOption: defaultDisplay,
                    isDone: false,
                    isSokuon: isSokuon,
                    nextConsonant: (!isCombo && !isSokuon && i + 1 < kana.length) ? getNodeConsonant(kana[i+1], kana[i+2]) : null
                });

                i += isCombo ? 2 : 1;
            }
            return nodes;
        };

        // --- SoundEngine Class ---
        class SoundEngine {
            constructor() {
                this.ctx = null;
                this.gainNode = null;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.ctx.createGain();
                    this.gainNode.connect(this.ctx.destination);
                    this.gainNode.gain.value = 0.15;
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            playType() {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);
                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.05);
            }

            playMiss() {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.2);
            }

            playSuccess() {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1800, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.15);
            }
        }

        const soundEngine = new SoundEngine();

        // --- GameApp Class ---
        class GameApp {
            constructor() {
                this.gameState = 'menu';
                this.isPaused = false;
                this.currentWordData = null;
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.timeLeft = 60;
                this.shake = false;
                this.feedback = null;
                this.timerInterval = null;
                
                this.settings = {
                    duration: 60,
                    sound: true,
                    displayMode: 'ime',
                    gameMode: 'normal',
                    weakKeyRate: 0.6,
                    ignoreVowels: false,
                    realMode: false
                };
                
                this.missStats = this.loadMissStats();
                this.focusKeys = this.loadFocusKeys();
                
                this.showSettings = false;
                this.settingsJustOpened = false;
                this.settingsScrollTop = 0;
                this.showStats = false;
                this.showKeyboardSelector = false;
                this.showRanking = false;
                this.rankings = [];
                this.rankingLoading = false;
                this.rankingError = '';
                this.isSavingRanking = false;
                this.currentRunMode = 'normal';
                this.pendingSettingsRestore = null;
                this.rankingNickname = localStorage.getItem(RANKING_MODE_STORAGE_KEY) || '';

                this.weeklyRankingSettings = this.createDefaultWeeklyRankingSettings();
                this.weeklySettingsLoading = false;
                this.weeklySettingsError = '';
                this.rankingLivesLeft = this.weeklyRankingSettings.lives;
                this.currentWordMissed = false;

                this.setupEventListeners();
                this.fetchWeeklyRankingSettings();
                this.render();
            }

            loadMissStats() {
                const saved = localStorage.getItem('neoTypeMissStats');
                return saved ? JSON.parse(saved) : {};
            }

            saveMissStats() {
                localStorage.setItem('neoTypeMissStats', JSON.stringify(this.missStats));
            }

            loadFocusKeys() {
                const saved = localStorage.getItem('neoTypeFocusKeys');
                return saved ? JSON.parse(saved) : [];
            }

            saveFocusKeys() {
                localStorage.setItem('neoTypeFocusKeys', JSON.stringify(this.focusKeys));
            }

            normalizeRankingNickname(value) {
                return (value || '').trim().slice(0, 20);
            }

            persistRankingNickname(value) {
                const normalized = this.normalizeRankingNickname(value);
                this.rankingNickname = normalized;
                if (normalized) {
                    localStorage.setItem(RANKING_MODE_STORAGE_KEY, normalized);
                } else {
                    localStorage.removeItem(RANKING_MODE_STORAGE_KEY);
                }
                return normalized;
            }

            createDefaultWeeklyRankingSettings() {
                return getDefaultWeeklyRankingSettings();
            }

            applyWeeklySettings(rawSettings = {}) {
                const normalized = normalizeWeeklyRankingSettings(rawSettings);
                const defaults = this.createDefaultWeeklyRankingSettings();
                this.weeklyRankingSettings = {
                    ...defaults,
                    ...normalized,
                    weekKey: (rawSettings.weekKey || defaults.weekKey).toString().trim() || defaults.weekKey,
                    weekLabel: (rawSettings.weekLabel || defaults.weekLabel).toString().trim() || defaults.weekLabel
                };
                return this.weeklyRankingSettings;
            }

            async fetchWeeklyRankingSettings() {
                this.weeklySettingsLoading = true;
                this.weeklySettingsError = '';
                this.render();

                await authReadyPromise;

                try {
                    const settingsRef = doc(db, ...WEEKLY_SETTINGS_DOC);
                    const snap = await getDoc(settingsRef);
                    if (snap.exists()) {
                        this.applyWeeklySettings(snap.data());
                    } else {
                        this.applyWeeklySettings({});
                    }
                } catch (error) {
                    console.error('Failed to fetch weekly ranking settings:', error);
                    this.weeklySettingsError = '週間ランキング設定の取得に失敗しました。';
                    this.applyWeeklySettings({});
                } finally {
                    this.weeklySettingsLoading = false;
                    this.render();
                }
            }

            setupEventListeners() {
                this.keyDownHandler = (e) => this.handleKeyDown(e);
                document.addEventListener('keydown', this.keyDownHandler);
            }

            destroy() {
                if (this.keyDownHandler) {
                    document.removeEventListener('keydown', this.keyDownHandler);
                }
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            }

            handleKeyDown(e) {
                if (this.showSettings || this.showStats || this.showKeyboardSelector || this.showRanking) return;
                if (this.isPaused) return;

                if (e.code === 'Space') {
                    if (this.gameState === 'menu' || this.gameState === 'finished') {
                        e.preventDefault();
                        this.startGame('normal');
                        return;
                    }
                    if (this.gameState === 'playing') {
                        e.preventDefault();
                        return;
                    }
                }

                if (this.gameState !== 'playing' || !this.currentWordData) return;
                if (['Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 'Tab', 'Escape'].includes(e.key)) return;

                if (e.key === 'Backspace' && this.settings.realMode) {
                    const nodes = [...this.currentWordData.nodes];
                    const activeNodeIndex = nodes.findIndex(n => !n.isDone);
                    
                    if (activeNodeIndex !== -1) {
                        const node = nodes[activeNodeIndex];
                        if (node.input.length > 0) {
                            node.input = node.input.slice(0, -1);
                            const validOption = node.options.find(opt => opt.startsWith(node.input));
                            if (validOption) {
                                node.selectedOption = validOption;
                            }
                            this.currentWordData.nodes = nodes;
                            this.render();
                        }
                    }
                    return;
                }

                const inputChar = e.key.toLowerCase();
                const nodes = [...this.currentWordData.nodes];
                const activeNodeIndex = nodes.findIndex(n => !n.isDone);
                
                if (activeNodeIndex === -1) return;

                const node = nodes[activeNodeIndex];
                const nextNode = nodes[activeNodeIndex + 1];

                let isCorrect = false;
                const currentInput = node.input + inputChar;

                // Special case: 促音 ('っ' + next consonant)
                if (!isCorrect && node.isSokuon && nextNode) {
                    const nextConsonants = nextNode.options.map(opt => opt[0]);
                    if (nextConsonants.includes(inputChar)) {
                        node.selectedOption = inputChar;
                        node.input = inputChar;
                        node.isDone = true;
                        isCorrect = true;
                    }
                }

                // Special case: 'ん' with 'n' + next input
                if (!isCorrect && node.char === 'ん' && node.input === 'n') {
                    if (nextNode) {
                        const nextNodeValidStart = nextNode.options.some(opt => opt.startsWith(inputChar));
                        if (nextNodeValidStart) {
                            node.isDone = true;
                            node.selectedOption = 'n';
                            
                            const nextNodeInput = inputChar;
                            const nextNodeValidOption = nextNode.options.find(opt => opt.startsWith(nextNodeInput));
                            
                            if (nextNodeValidOption) {
                                nextNode.input = nextNodeInput;
                                nextNode.selectedOption = nextNodeValidOption;
                                if (nextNode.input === nextNodeValidOption) nextNode.isDone = true;
                                isCorrect = true;
                            } else if (this.settings.realMode) {
                                nextNode.input = nextNodeInput;
                            }
                        }
                    }
                }

                // Normal input logic
                if (!isCorrect) {
                    if (this.settings.realMode) {
                        node.input = currentInput;
                        
                        const isPrefixOfAnyOption = node.options.some(opt => opt.startsWith(currentInput));
                        if (isPrefixOfAnyOption) {
                            isCorrect = true;
                            const bestMatch = node.options.find(opt => opt.startsWith(currentInput));
                            if (bestMatch) node.selectedOption = bestMatch;
                            
                            if (node.input === node.selectedOption) {
                                node.isDone = true;
                            }
                        } else {
                            isCorrect = false;
                        }
                    } else {
                        const validOption = node.options.find(opt => opt.startsWith(currentInput));
                        if (validOption) {
                            isCorrect = true;
                            node.input = currentInput;
                            node.selectedOption = validOption;
                            if (node.input === validOption) {
                                node.isDone = true;
                            }
                        }
                    }
                }

                if (isCorrect) {
                    this.playSound('type');
                    this.combo++;
                    if (this.combo > this.maxCombo) this.maxCombo = this.combo;
                    this.currentWordData.nodes = nodes;

                    if (nodes.every(n => n.isDone)) {
                        const addedScore = 100 + (this.combo * 10);
                        this.score += addedScore;
                        this.setFeedback('Perfect!', 'success');
                        this.playSound('success');
                        this.pickNextWord();
                    }
                } else {
                    this.playSound('miss');
                    this.combo = 0;
                    this.shake = true;
                    setTimeout(() => {
                        this.shake = false;
                        this.render();
                    }, 300);
                    this.setFeedback('Miss!', 'miss');
                    
                    if (this.settings.realMode) {
                        this.currentWordData.nodes = nodes;
                    }

                    const targetChar = node.selectedOption[node.input.length] || node.selectedOption[0];
                    if (targetChar) {
                        this.missStats[targetChar] = (this.missStats[targetChar] || 0) + 1;
                    }

                    if (this.currentRunMode === 'ranking' && !this.currentWordMissed) {
                        this.currentWordMissed = true;
                        this.rankingLivesLeft = Math.max(0, (this.rankingLivesLeft ?? this.settings.lives) - 1);
                        if (this.rankingLivesLeft <= 0) {
                            this.endGame();
                            return;
                        }
                    }
                }

                this.render();
            }

            playSound(type) {
                if (!this.settings.sound) return;
                try {
                    if (type === 'type') soundEngine.playType();
                    if (type === 'miss') soundEngine.playMiss();
                    if (type === 'success') soundEngine.playSuccess();
                } catch (e) {
                    console.error("Audio playback error:", e);
                }
            }

            setFeedback(text, tone = 'success') {
                this.feedback = { id: Date.now(), text, tone };
                setTimeout(() => {
                    this.feedback = null;
                    this.render();
                }, 600);
            }

            applyRankingModeSettings() {
                this.pendingSettingsRestore = cloneSettings(this.settings);
                const weeklySettings = this.weeklyRankingSettings || this.createDefaultWeeklyRankingSettings();
                this.settings = {
                    ...this.settings,
                    ...normalizeWeeklyRankingSettings(weeklySettings),
                    displayMode: this.pendingSettingsRestore.displayMode,
                    sound: this.pendingSettingsRestore.sound
                };
                this.rankingLivesLeft = this.settings.lives;
            }

            restoreSettingsIfNeeded() {
                if (!this.pendingSettingsRestore) return;
                this.settings = this.pendingSettingsRestore;
                this.pendingSettingsRestore = null;
            }

            async startGame(mode = 'normal') {
                this.currentRunMode = mode;

                if (mode === 'ranking') {
                    await this.fetchWeeklyRankingSettings();
                    this.applyRankingModeSettings();
                } else {
                    this.restoreSettingsIfNeeded();
                }

                if (this.settings.sound) soundEngine.init();

                this.gameState = 'playing';
                this.isPaused = false;
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.timeLeft = this.settings.duration;
                this.feedback = null;
                this.rankingLivesLeft = this.currentRunMode === 'ranking' ? this.settings.lives : null;
                this.pickNextWord();
                this.startTimer();
                this.render();
            }

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                
                this.timerInterval = setInterval(() => {
                    if (this.gameState !== 'playing' || this.isPaused) return;
                    
                    this.timeLeft--;
                    if (this.timeLeft <= 0) {
                        this.endGame();
                    }
                    this.render();
                }, 1000);
            }

            endGame() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.gameState = 'finished';
                if (this.settings.sound) soundEngine.playSuccess();
                this.saveMissStats();
                this.render();
                if (this.currentRunMode === 'ranking') {
                    this.saveScoreToRanking();
                }
            }
            async saveScoreToRanking() {
                if (this.isSavingRanking) return;

                let nickname = this.normalizeRankingNickname(this.rankingNickname);
                if (!nickname) {
                    const inputName = prompt('ランキング登録名を入力してください（設定からいつでも変更できます）');
                    nickname = this.persistRankingNickname(inputName);
                    if (!nickname) return;
                }

                this.isSavingRanking = true;

                await authReadyPromise;

                try {
                    await addDoc(collection(db, 'rankings'), {
                        mode: 'ranking',
                        name: nickname,
                        score: this.score,
                        weekKey: this.weeklyRankingSettings.weekKey,
                        weekLabel: this.weeklyRankingSettings.weekLabel,
                        createdAt: serverTimestamp()
                    });
                    this.setLastSubmittedRanking(nickname, this.score);
                } catch (error) {
                    console.error('Failed to save ranking score:', error);
                    alert('ランキング保存に失敗しました。ネットワーク状況を確認して再度お試しください。');
                } finally {
                    this.isSavingRanking = false;
                }
            }

            async fetchRankings() {
                this.rankingLoading = true;
                this.rankingError = '';
                this.rankings = [];
                this.render();

                await authReadyPromise;

                try {
                    const rankingsQuery = query(
                        collection(db, 'rankings'),
                        orderBy('score', 'desc'),
                        limit(200)
                    );
                    const snapshot = await getDocs(rankingsQuery);
                    const uniqueByName = new Map();

                    snapshot.docs.forEach((docSnap) => {
                        const data = docSnap.data();
                        if (data.mode !== 'ranking') return;
                        if ((data.weekKey || '') !== this.weeklyRankingSettings.weekKey) return;

                        const key = (data.name || '').trim().toLowerCase();
                        if (!key || uniqueByName.has(key)) return;
                        uniqueByName.set(key, {
                            id: docSnap.id,
                            ...data
                        });
                    });

                    this.rankings = Array.from(uniqueByName.values())
                        .slice(0, 10)
                        .map((item, index) => ({
                            ...item,
                            rank: index + 1
                        }));
                } catch (error) {
                    console.error('Failed to fetch rankings:', error);
                    this.rankingError = 'ランキングの取得に失敗しました。時間をおいて再度お試しください。';
                    this.rankings = [];
                } finally {
                    this.rankingLoading = false;
                    this.render();
                }
            }

            async openRankingModal() {
                if (this.showRanking) return;
                this.showRanking = true;
                this.render();
                await this.fetchWeeklyRankingSettings();
                this.fetchRankings();
            }

            closeRankingModal() {
                this.showRanking = false;
                this.render();
            }

            pickNextWord() {
                this.currentWordMissed = false;
                let autoWeakKeys = Object.entries(this.missStats)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5)
                    .map(([key]) => key);

                if (this.settings.ignoreVowels) {
                    const vowels = ['a', 'i', 'u', 'e', 'o', '-'];
                    autoWeakKeys = autoWeakKeys.filter(k => !vowels.includes(k));
                }

                const isRankingMode = this.currentRunMode === 'ranking';
                const manualFocusKeys = isRankingMode ? [] : (this.focusKeys || []);
                let targetKeys = isRankingMode ? [] : Array.from(new Set([...autoWeakKeys, ...manualFocusKeys]));

                if (this.settings.ignoreVowels) {
                    const vowels = ['a', 'i', 'u', 'e', 'o', '-'];
                    targetKeys = targetKeys.filter(k => !vowels.includes(k));
                }

                const wordList = this.settings.gameMode === 'legal' ? LEGAL_WORDS : INITIAL_WORDS;

                let candidates = [];
                let isWeakMode = false;

                if (targetKeys.length > 0 && Math.random() < this.settings.weakKeyRate) {
                    candidates = wordList.filter(word => {
                        const defaultRomaji = parseKana(word.kana).map(n => n.options[0]).join('');
                        return targetKeys.some(k => defaultRomaji.includes(k));
                    });
                    if (candidates.length > 0) {
                        isWeakMode = true;
                    }
                }

                if (candidates.length === 0) {
                    candidates = wordList;
                    isWeakMode = false;
                }

                const nextWord = candidates[Math.floor(Math.random() * candidates.length)];
                this.currentWordData = {
                    text: nextWord.text,
                    kana: nextWord.kana,
                    nodes: parseKana(nextWord.kana),
                    isWeakMode: isWeakMode
                };
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                this.render();
            }

            resetStats() {
                if (confirm("学習データを完全にリセットしますか？\n(Weak Keys Analysis Reset)")) {
                    this.missStats = {};
                    localStorage.removeItem('neoTypeMissStats');
                    this.showStats = false;
                    this.render();
                }
            }

            toggleFocusKey(key) {
                const index = this.focusKeys.indexOf(key);
                if (index > -1) {
                    this.focusKeys.splice(index, 1);
                } else {
                    this.focusKeys.push(key);
                }
                this.saveFocusKeys();
                this.render();
            }

            escapeHtml(text) {
                if (!this._escapeDiv) {
                    this._escapeDiv = document.createElement('div');
                }
                this._escapeDiv.textContent = text;
                return this._escapeDiv.innerHTML;
            }

            // --- Render Methods ---
            render() {
                const app = document.getElementById('app');
                const currentSettingsPanel = document.getElementById('settingsPanel');

                if (currentSettingsPanel) {
                    this.settingsScrollTop = currentSettingsPanel.scrollTop;
                }
                
                if (this.gameState === 'menu') {
                    app.innerHTML = this.renderMenu();
                } else if (this.gameState === 'finished') {
                    app.innerHTML = this.renderResults();
                } else if (this.gameState === 'playing') {
                    app.innerHTML = this.renderPlaying();
                }
                
                this.attachEventHandlers();

                if (this.showSettings) {
                    const nextSettingsPanel = document.getElementById('settingsPanel');
                    if (nextSettingsPanel) {
                        nextSettingsPanel.scrollTop = this.settingsScrollTop;
                    }
                    this.settingsJustOpened = false;
                }
            }

            attachEventHandlers() {
                // Menu buttons
                const startBtn = document.getElementById('startBtn');
                if (startBtn) startBtn.onclick = () => this.startGame('normal');

                const rankingStartBtn = document.getElementById('rankingStartBtn');
                if (rankingStartBtn) rankingStartBtn.onclick = () => this.startGame('ranking');
                
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) settingsBtn.onclick = () => {
                    this.showSettings = true;
                    this.settingsJustOpened = true;
                    this.settingsScrollTop = 0;
                    this.render();
                };
                
                const statsBtn = document.getElementById('statsBtn');
                if (statsBtn) statsBtn.onclick = () => {
                    this.showStats = true;
                    this.render();
                };

                const rankingBtn = document.getElementById('rankingBtn');
                if (rankingBtn) rankingBtn.onclick = () => this.openRankingModal();

                const closeRankingBtn = document.getElementById('closeRankingBtn');
                if (closeRankingBtn) closeRankingBtn.onclick = () => this.closeRankingModal();

                const reloadRankingBtn = document.getElementById('reloadRankingBtn');
                if (reloadRankingBtn) reloadRankingBtn.onclick = () => this.fetchRankings();

                const rankingOverlay = document.getElementById('rankingOverlay');
                if (rankingOverlay) rankingOverlay.onclick = (e) => {
                    if (e.target === rankingOverlay) this.closeRankingModal();
                };
                
                // Settings modal
                const closeSettingsBtn = document.getElementById('closeSettingsBtn');
                if (closeSettingsBtn) closeSettingsBtn.onclick = () => {
                    this.showSettings = false;
                    this.settingsJustOpened = false;
                    this.render();
                };
                
                const saveSettingsBtn = document.getElementById('saveSettingsBtn');
                if (saveSettingsBtn) saveSettingsBtn.onclick = () => {
                    this.showSettings = false;
                    this.settingsJustOpened = false;
                    this.render();
                };

                const saveRankingNicknameBtn = document.getElementById('saveRankingNicknameBtn');
                if (saveRankingNicknameBtn) saveRankingNicknameBtn.onclick = () => {
                    const input = document.getElementById('rankingNicknameInput');
                    const nickname = this.persistRankingNickname(input ? input.value : '');
                    if (!nickname) {
                        alert('ランキング登録名を1文字以上入力してください。');
                        return;
                    }
                    alert('ランキング登録名を保存しました。');
                    this.render();
                };

                // Duration buttons
                [30, 60, 90, 120, 180, 300].forEach(time => {
                    const btn = document.getElementById(`duration${time}`);
                    if (btn) btn.onclick = () => {
                        this.settings.duration = time;
                        this.render();
                    };
                });
                
                // Sound toggle
                const soundOnBtn = document.getElementById('soundOn');
                if (soundOnBtn) soundOnBtn.onclick = () => {
                    this.settings.sound = true;
                    this.render();
                };
                
                const soundOffBtn = document.getElementById('soundOff');
                if (soundOffBtn) soundOffBtn.onclick = () => {
                    this.settings.sound = false;
                    this.render();
                };
                
                // Display mode buttons
                const imeBtn = document.getElementById('displayIme');
                if (imeBtn) imeBtn.onclick = () => {
                    this.settings.displayMode = 'ime';
                    this.render();
                };
                
                const inputBtn = document.getElementById('displayInput');
                if (inputBtn) inputBtn.onclick = () => {
                    this.settings.displayMode = 'input';
                    this.render();
                };
                
                const guideBtn = document.getElementById('displayGuide');
                if (guideBtn) guideBtn.onclick = () => {
                    this.settings.displayMode = 'guide';
                    this.render();
                };
                
                // Toggle switches
                const legalModeSwitch = document.getElementById('legalModeSwitch');
                if (legalModeSwitch) legalModeSwitch.onclick = () => {
                    this.settings.gameMode = this.settings.gameMode === 'legal' ? 'normal' : 'legal';
                    this.render();
                };
                
                const realModeSwitch = document.getElementById('realModeSwitch');
                if (realModeSwitch) realModeSwitch.onclick = () => {
                    this.settings.realMode = !this.settings.realMode;
                    this.render();
                };
                
                const ignoreVowelsSwitch = document.getElementById('ignoreVowelsSwitch');
                if (ignoreVowelsSwitch) ignoreVowelsSwitch.onclick = () => {
                    this.settings.ignoreVowels = !this.settings.ignoreVowels;
                    this.render();
                };
                
                // Weak key rate slider
                const weakKeyRateSlider = document.getElementById('weakKeyRateSlider');
                if (weakKeyRateSlider) weakKeyRateSlider.oninput = (e) => {
                    this.settings.weakKeyRate = parseFloat(e.target.value);
                    this.render();
                };
                
                // Keyboard selector
                const openKeyboardBtn = document.getElementById('openKeyboardBtn');
                if (openKeyboardBtn) openKeyboardBtn.onclick = () => {
                    this.showKeyboardSelector = true;
                    this.render();
                };
                
                const closeKeyboardBtn = document.getElementById('closeKeyboardBtn');
                if (closeKeyboardBtn) closeKeyboardBtn.onclick = () => {
                    this.showKeyboardSelector = false;
                    this.render();
                };
                
                const clearKeysBtn = document.getElementById('clearKeysBtn');
                if (clearKeysBtn) clearKeysBtn.onclick = () => {
                    this.focusKeys = [];
                    this.saveFocusKeys();
                    this.render();
                };
                
                const doneKeyboardBtn = document.getElementById('doneKeyboardBtn');
                if (doneKeyboardBtn) doneKeyboardBtn.onclick = () => {
                    this.showKeyboardSelector = false;
                    this.render();
                };
                
                // Keyboard keys
                KEYBOARD_LAYOUT.flat().forEach(key => {
                    const btn = document.getElementById(`key-${key}`);
                    if (btn) btn.onclick = () => this.toggleFocusKey(key);
                });
                
                // Stats modal
                const closeStatsBtn = document.getElementById('closeStatsBtn');
                if (closeStatsBtn) closeStatsBtn.onclick = () => {
                    this.showStats = false;
                    this.render();
                };
                
                const resetStatsBtn = document.getElementById('resetStatsBtn');
                if (resetStatsBtn) resetStatsBtn.onclick = () => this.resetStats();
                
                const viewDetailsBtn = document.getElementById('viewDetailsBtn');
                if (viewDetailsBtn) viewDetailsBtn.onclick = () => {
                    this.showStats = true;
                    this.render();
                };
                
                // Playing buttons
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) pauseBtn.onclick = () => {
                    this.isPaused = true;
                    this.render();
                };
                
                const resumeBtn = document.getElementById('resumeBtn');
                if (resumeBtn) resumeBtn.onclick = () => {
                    this.isPaused = false;
                    this.render();
                };
                
                const quitBtn = document.getElementById('quitBtn');
                if (quitBtn) quitBtn.onclick = () => {
                    this.gameState = 'menu';
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    this.currentRunMode = 'normal';
                    this.restoreSettingsIfNeeded();
                    this.render();
                };
                
                // Results buttons
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) retryBtn.onclick = () => this.startGame(this.currentRunMode);
                
                const backToMenuBtn = document.getElementById('backToMenuBtn');
                if (backToMenuBtn) backToMenuBtn.onclick = () => {
                    this.gameState = 'menu';
                    this.currentRunMode = 'normal';
                    this.restoreSettingsIfNeeded();
                    this.render();
                };
            }

            renderIcon(name) {
                return INLINE_ICONS[name] || '';
            }

            renderSwitch(checked) {
                return `
                    <div class="toggle-track ${checked ? 'on' : ''}">
                        <div class="toggle-thumb"></div>
                    </div>
                `;
            }
            renderLivesHearts(totalLives, remainingLives) {
                const total = Math.max(0, Number(totalLives) || 0);
                const remaining = Math.max(0, Number(remainingLives) || 0);
                return Array.from({ length: total }).map((_, index) => {
                    const empty = index >= remaining;
                    return `<span class="life-heart ${empty ? 'empty' : ''}">${this.renderIcon('heart')}</span>`;
                }).join('');
            }


            renderSettingRow(title, description, controlHtml) {
                return `
                    <div class="setting-row">
                        <div class="setting-meta">
                            <div class="setting-title">${title}</div>
                            <div class="setting-desc">${description}</div>
                        </div>
                        <div class="setting-control">${controlHtml}</div>
                    </div>
                `;
            }

            renderRankingButton() {
                return `
                    <button id="rankingBtn" class="fixed top-6 left-0 z-20 px-4 py-2 font-bold flex items-center gap-2 app-btn-accent" style="margin-left: 1rem;">
                        ${this.renderIcon('trophy')} ランキング
                    </button>
                `;
            }

            renderRankingModal() {
                return `
                    <div id="rankingOverlay" class="fixed inset-0 z-50 app-overlay flex items-center justify-center p-4">
                        <div class="w-full max-w-xl app-panel p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-2xl font-bold flex items-center gap-2" style="color: var(--settings-text);">${this.renderIcon('trophy')} 週間ランキング</h3>
                                <div class="flex items-center gap-2">
                                    <button id="reloadRankingBtn" class="px-3 py-2 text-sm app-btn-secondary">更新</button>
                                    <button id="closeRankingBtn" class="p-2 app-btn-secondary">${this.renderIcon('x')}</button>
                                </div>
                            </div>

                            <div class="mb-3 text-sm" style="color: var(--settings-text-muted);">
                                対象週: <strong>${this.escapeHtml(this.weeklyRankingSettings.weekLabel)}</strong> (${this.escapeHtml(this.weeklyRankingSettings.weekKey)}) / ${this.weeklyRankingSettings.gameMode === 'legal' ? '法律用語' : '通常'} / ${this.weeklyRankingSettings.duration}秒 / ライフ${this.weeklyRankingSettings.lives}
                            </div>

                            ${this.rankingLoading ? `
                                <div class="text-center py-8" style="color: var(--settings-text-muted);">読み込み中...</div>
                            ` : this.rankingError ? `
                                <div class="text-center rounded-lg py-4 px-3" style="background: rgba(239,68,68,0.15); border: 1px solid rgba(248,113,113,0.38); color: #fecaca;">${this.rankingError}</div>
                            ` : this.rankings.length === 0 ? `
                                <div class="text-center rounded-lg py-8" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(148,163,184,0.25); color: var(--settings-text-muted);">まだスコアが登録されていません。</div>
                            ` : `
                                <div class="space-y-2 overflow-y-auto pr-1" style="max-height: 60vh;">
                                    ${this.rankings.map((item) => {
                                        const isPlayerEntry = this.isPlayerRankingEntry(item);
                                        return `
                                        <div class="flex items-center justify-between rounded-lg px-4 py-3" style="background: ${isPlayerEntry ? 'rgba(45,212,191,0.16)' : 'rgba(255,255,255,0.04)'}; border: 1px solid ${isPlayerEntry ? 'rgba(45,212,191,0.65)' : 'rgba(148,163,184,0.2)'}; box-shadow: ${isPlayerEntry ? '0 0 0 1px rgba(45,212,191,0.22), 0 0 20px rgba(45,212,191,0.2)' : 'none'};">
                                            <div class="flex items-center gap-3">
                                                <span class="font-black w-12" style="color: ${isPlayerEntry ? '#5eead4' : '#facc15'};">#${item.rank}</span>
                                                <span class="font-bold" style="color: ${isPlayerEntry ? '#99f6e4' : 'var(--settings-text)'};">${this.escapeHtml(item.name || 'NO NAME')}</span>
                                            </div>
                                            <span class="font-mono font-bold" style="color: ${isPlayerEntry ? '#2dd4bf' : '#67e8f9'};">${Number(item.score || 0).toLocaleString()} pts</span>
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderMenu() {
                return `
                    <div class="app-shell ${this.currentRunMode === 'ranking' ? 'ranking-theme' : ''} flex flex-col items-center justify-center p-4 font-sans select-none relative overflow-hidden">
                        ${this.renderRankingButton()}
                        ${this.showKeyboardSelector ? this.renderKeyboardSelector() : ''}
                        ${this.showSettings ? this.renderSettings() : ''}
                        ${this.showStats ? this.renderStatsPanel() : ''}
                        ${this.showRanking ? this.renderRankingModal() : ''}
                        
                        <button id="settingsBtn" class="absolute top-6 right-6 p-3 app-btn-secondary z-10">
                            ${this.renderIcon('settings')}
                        </button>

                        <div class="max-w-md w-full text-center space-y-8">
                            <div class="space-y-2">
                                <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 tracking-tighter filter drop-shadow-lg">
                                    NEO-TYPE
                                    <span class="text-sm font-normal text-slate-500 block mt-2 tracking-widest">さよなら苦手キー</span>
                                </h1>
                            </div>
                            
                            <div class="app-panel p-6 space-y-4">
                                <p class="mb-4 text-sm text-slate-300 leading-relaxed text-left">
                                    あなたが指定した苦手キーと過去のミス回数を学習、分析し、今のあなたに最適な問題を出し続け、最短ルートでのタイピング力向上をサポートします。
                                </p>
                                
                                <div class="flex flex-col gap-3">
                                    <button id="startBtn" class="group relative w-full px-8 py-4 text-xl overflow-hidden app-btn-primary">
                                        <span class="relative z-10 flex items-center justify-center gap-2">
                                            ${this.settings.gameMode === 'legal' ? this.renderIcon('scale') : this.renderIcon('play')} START
                                        </span>
                                    </button>
                                    <button id="rankingStartBtn" class="w-full px-8 py-3 text-lg app-btn-accent">
                                        ${this.renderIcon('trophy')} RANKING MODE START
                                    </button>
                                    <div class="text-xs text-slate-500 font-mono">Press [SPACE] to Start</div>
                                </div>

                                <button id="statsBtn" class="w-full py-3 mt-2 app-btn-secondary flex items-center justify-center gap-2">
                                    ${this.renderIcon('bar-chart-2')} 学習データ詳細を見る
                                </button>
                            </div>
                            
                            <div class="text-xs flex justify-center gap-4 flex-wrap" style="color: var(--settings-text-subtle);">
                                <span class="flex items-center gap-1">${this.renderIcon('clock')} ${this.settings.duration}s</span>
                                <span class="flex items-center gap-1">
                                    ${this.settings.sound ? this.renderIcon('volume-2') : this.renderIcon('volume-x')} ${this.settings.sound ? 'ON' : 'OFF'}
                                </span>
                                <span class="flex items-center gap-1 text-cyan-500">
                                    ${this.settings.displayMode === 'ime' ? this.renderIcon('languages') : ''}
                                    ${this.settings.displayMode === 'guide' ? this.renderIcon('eye') : ''}
                                    ${this.settings.displayMode === 'input' ? this.renderIcon('eye-off') : ''}
                                    ${this.settings.displayMode === 'ime' ? 'IME' : this.settings.displayMode === 'guide' ? 'Guide' : 'Input'}
                                </span>
                                <span class="flex items-center gap-1 ${this.settings.gameMode === 'legal' ? 'text-indigo-400 font-bold' : 'text-slate-500'}">
                                    ${this.settings.gameMode === 'legal' ? this.renderIcon('scale') : this.renderIcon('keyboard')}
                                    ${this.settings.gameMode === 'legal' ? 'Legal Mode' : 'Normal'}
                                </span>
                                ${this.settings.realMode ? `<span class="flex items-center gap-1 text-red-400 font-bold">${this.renderIcon('delete')} Real Mode</span>` : ''}
                            </div>
                        </div>
                        <div class="absolute bottom-4 right-4 text-xs font-mono select-none" style="color: var(--settings-text-subtle);">
                            © Tadashi Kotegawa
                        </div>
                    </div>
                `;
            }

            renderSettings() {
                const weakRate = Math.round(this.settings.weakKeyRate * 100);
                const selectedKeys = this.focusKeys.length > 0
                    ? `<span class="font-mono" style="color: var(--settings-accent);">${this.focusKeys.join(', ').toUpperCase()}</span>`
                    : '未選択（自動分析のみ）';

                return `
                    <div class="absolute inset-0 z-50 flex items-center justify-center p-4 backdrop-blur-sm ${this.settingsJustOpened ? 'animate-in fade-in duration-200' : ''}" style="background: rgba(6, 10, 20, 0.88);">
                        <div id="settingsPanel" class="settings-panel w-full max-w-xl relative max-h-[85vh] overflow-y-auto space-y-6">
                            <button id="closeSettingsBtn" class="absolute top-4 right-4 text-slate-500 hover:text-white">
                                ${this.renderIcon('x')}
                            </button>
                            <h2 class="text-2xl font-bold flex items-center gap-2 pb-4" style="color: var(--settings-text);">
                                ${this.renderIcon('settings')} Settings
                            </h2>

                            <section class="settings-section">
                                <div class="settings-section-title">${this.renderIcon('clock')} Game Duration</div>
                                ${this.renderSettingRow(
                                    'プレイ時間',
                                    'ラウンド時間を選択します',
                                    `<div class="segment-wrap segment-3">${[30, 60, 90, 120, 180, 300].map(time => `
                                        <button id="duration${time}" class="segment-btn ${this.settings.duration === time ? 'active' : ''}">${time}s</button>
                                    `).join('')}</div>`
                                )}
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-title">${this.renderIcon('target')} 苦手キー設定</div>
                                ${this.renderSettingRow(
                                    '重点キー選択',
                                    selectedKeys,
                                    `<button id="openKeyboardBtn" class="settings-btn" style="width: 100%;">${this.renderIcon('keyboard')} キーボードから選択</button>`
                                )}
                                ${this.renderSettingRow(
                                    '母音を除外',
                                    'AIUEO を分析対象から外します',
                                    `<button id="ignoreVowelsSwitch" class="toggle-btn">${this.renderSwitch(this.settings.ignoreVowels)}</button>`
                                )}
                                ${this.renderSettingRow(
                                    '苦手キー出現率',
                                    '重点キーが出現する割合',
                                    `<div class="slider-wrap"><input id="weakKeyRateSlider" type="range" min="0" max="1" step="0.1" value="${this.settings.weakKeyRate}" class="settings-slider" /><span class="slider-value">${weakRate}%</span></div>`
                                )}
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-title">${this.settings.sound ? this.renderIcon('volume-2') : this.renderIcon('volume-x')} Sound</div>
                                ${this.renderSettingRow(
                                    '効果音',
                                    'タイプ音と通知音を切り替えます',
                                    `<div class="segment-wrap segment-2" style="width: 100%;">
                                        <button id="soundOn" class="segment-btn ${this.settings.sound ? 'active' : ''}">ON</button>
                                        <button id="soundOff" class="segment-btn ${!this.settings.sound ? 'active' : ''}">OFF</button>
                                    </div>`
                                )}
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-title">${this.renderIcon('eye')} Display</div>
                                ${this.renderSettingRow(
                                    'DISPLAY MODE',
                                    '表示方法を統一タブで切替',
                                    `<div class="segment-wrap segment-3" style="width: 100%;">
                                        <button id="displayIme" class="segment-btn ${this.settings.displayMode === 'ime' ? 'active' : ''}"><span>${this.renderIcon('languages')} IME</span><small>ひらがな変換</small></button>
                                        <button id="displayInput" class="segment-btn ${this.settings.displayMode === 'input' ? 'active' : ''}"><span>${this.renderIcon('eye-off')} Input</span><small>打つと表示</small></button>
                                        <button id="displayGuide" class="segment-btn ${this.settings.displayMode === 'guide' ? 'active' : ''}"><span>${this.renderIcon('eye')} Guide</span><small>最初から表示</small></button>
                                    </div>`
                                )}
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-title">${this.renderIcon('settings')} Modes</div>
                                ${this.renderSettingRow(
                                    'Legal Terms Mode',
                                    '法律用語（200語）で練習します',
                                    `<button id="legalModeSwitch" class="toggle-btn">${this.renderSwitch(this.settings.gameMode === 'legal')}</button>`
                                )}
                                ${this.renderSettingRow(
                                    'Real Typing Mode',
                                    'ミスを Backspace で消す実戦形式',
                                    `<button id="realModeSwitch" class="toggle-btn">${this.renderSwitch(this.settings.realMode)}</button>`
                                )}
                            </section>

                            <section class="settings-section">
                                <div class="settings-section-title">${this.renderIcon('trophy')} Ranking</div>
                                ${this.renderSettingRow(
                                    'ランキング登録名',
                                    'ランキングモードで使う名前を設定',
                                    `<div class="flex gap-2" style="width: 100%;">
                                        <input id="rankingNicknameInput" type="text" maxlength="20" value="${this.escapeHtml(this.rankingNickname || '')}" placeholder="ランキングに表示する名前" class="settings-input" />
                                        <button id="saveRankingNicknameBtn" class="settings-btn active" style="padding: 0 16px; white-space: nowrap;">保存</button>
                                    </div>`
                                )}
                                ${this.renderSettingRow(
                                    '週間ランキング設定（運営）',
                                    '管理用サイトで今週ルールを編集します',
                                    `<a href="./admin.html" target="_blank" rel="noopener noreferrer" class="settings-btn active" style="width: 100%; text-align: center;">管理サイトを開く</a>`
                                )}
                            </section>

                            <button id="saveSettingsBtn" class="settings-btn active" style="width: 100%;">
                                Close & Save
                            </button>
                        </div>
                    </div>
                `;
            }

            renderKeyboardSelector() {
                return `
                    <div class="absolute inset-0 z-[60] app-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
                        <div class="app-panel p-8 w-full max-w-3xl relative flex flex-col items-center">
                            <button id="closeKeyboardBtn" class="absolute top-4 right-4 text-slate-500 hover:text-white">
                                ${this.renderIcon('x')}
                            </button>
                            
                            <h3 class="text-xl font-bold text-slate-200 mb-2 flex items-center gap-2">
                                ${this.renderIcon('target')} 苦手キーを指定
                            </h3>
                            <p class="text-slate-400 text-sm mb-8">
                                クリックして重点的に練習したいキーを選択してください（青色が選択中）
                            </p>

                            <div class="flex flex-col gap-2 mb-8 select-none">
                                ${KEYBOARD_LAYOUT.map((row, rowIndex) => `
                                    <div class="flex justify-center gap-2">
                                        ${row.map(key => {
                                            const isSelected = this.focusKeys.includes(key);
                                            return `
                                                <button id="key-${key}" class="app-key-btn transition-all duration-150 transform active:scale-95 ${isSelected ? 'active' : ''}">
                                                    ${key}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="flex gap-4">
                                <button id="clearKeysBtn" class="px-6 py-3 app-btn-secondary">
                                    Clear All
                                </button>
                                <button id="doneKeyboardBtn" class="px-8 py-3 app-btn-primary">
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderStatsPanel() {
                const sortedStats = Object.entries(this.missStats).sort(([, a], [, b]) => b - a);
                
                return `
                    <div class="absolute inset-0 z-50 app-overlay flex items-center justify-center p-4 animate-in fade-in duration-200">
                        <div class="app-panel w-full max-w-2xl h-[80vh] flex flex-col">
                            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                                <h2 class="text-2xl font-bold flex items-center gap-3">
                                    ${this.renderIcon('bar-chart-2')} 
                                    Learning Data
                                    <span class="text-sm font-normal text-slate-400 ml-2">累積ミス回数ランキング</span>
                                </h2>
                                <button id="closeStatsBtn" class="p-2 app-btn-secondary">
                                    ${this.renderIcon('x')}
                                </button>
                            </div>

                            <div class="flex-1 overflow-y-auto p-6">
                                ${sortedStats.length === 0 ? `
                                    <div class="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
                                        ${this.renderIcon('trophy')}
                                        <p>データがありません。ゲームをプレイしてデータを集めましょう。</p>
                                    </div>
                                ` : `
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        ${sortedStats.map(([key, count], index) => `
                                            <div class="flex items-center justify-between bg-slate-700/50 p-4 rounded-xl border border-slate-700/50">
                                                <div class="flex items-center gap-4">
                                                    <span class="flex items-center justify-center w-8 h-8 rounded font-bold text-sm ${
                                                        index === 0 ? 'bg-yellow-500 text-black' : 
                                                        index === 1 ? 'bg-gray-400 text-black' : 
                                                        index === 2 ? 'bg-orange-600 text-white' : 'bg-slate-600 text-slate-300'
                                                    }">
                                                        ${index + 1}
                                                    </span>
                                                    <span class="text-3xl font-mono font-bold text-white uppercase">${key}</span>
                                                </div>
                                                <div class="text-right">
                                                    <span class="text-2xl font-bold text-red-400">${count}</span>
                                                    <span class="text-xs text-slate-500 block">misses</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-6 flex justify-between items-center rounded-b-2xl" style="border-top: 1px solid rgba(148,163,184,0.24); background: rgba(255,255,255,0.03);">
                                <button id="resetStatsBtn" class="flex items-center gap-2 text-sm px-4 py-2 app-btn-danger">
                                    ${this.renderIcon('trash-2')} データリセット
                                </button>
                                <button id="closeStatsBtn" class="px-6 py-2 app-btn-secondary">
                                    閉じる
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderPlaying() {
                if (!this.currentWordData) return '';
                
                const activeNodeIndex = this.currentWordData.nodes.findIndex(n => !n.isDone);
                
                return `
                    <div class="app-shell ${this.currentRunMode === 'ranking' ? 'ranking-theme' : ''} flex flex-col font-sans select-none overflow-hidden relative">
                        ${this.renderRankingButton()}
                        ${this.showRanking ? this.renderRankingModal() : ''}
                        ${this.isPaused ? this.renderPauseOverlay() : ''}

                        <div class="p-6 flex justify-between items-end sticky top-0 z-10" style="border-bottom: 1px solid rgba(148,163,184,0.2); background: rgba(12,20,34,0.9); backdrop-filter: blur(8px);">
                            <div class="space-y-1">
                                <div class="text-sm text-slate-400 font-bold tracking-wider">SCORE</div>
                                <div class="text-4xl font-mono font-bold leading-none ${this.settings.gameMode === 'legal' ? 'text-indigo-400' : 'text-cyan-400'}">${this.score.toLocaleString()}</div>
                            </div>
                            
                            <div class="flex-1 mx-8 max-w-xl">
                                <div class="flex justify-between text-xs text-slate-400 mb-1">
                                    <span class="flex items-center gap-2">
                                        TIME LIMIT
                                        ${this.settings.gameMode === 'legal' ? `<span class="bg-indigo-900 text-indigo-300 px-2 rounded-full text-[10px] font-bold border border-indigo-700 flex items-center gap-1">${this.renderIcon('scale')} LEGAL MODE</span>` : ''}
                                        ${this.settings.realMode ? `<span class="bg-red-900 text-red-300 px-2 rounded-full text-[10px] font-bold border border-red-700 flex items-center gap-1">${this.renderIcon('delete')} REAL MODE</span>` : ''}
                                        ${this.currentRunMode === 'ranking' ? `<span class="inline-flex items-center gap-2 bg-amber-950/70 text-amber-200 px-2 py-1 rounded-full text-[10px] font-bold border border-amber-600/70"><span>LIFE</span><span class="life-hearts">${this.renderLivesHearts(this.settings.lives, this.rankingLivesLeft)}</span></span>` : ''}
                                    </span>
                                    <span class="${this.timeLeft < 10 ? 'text-red-500 animate-pulse' : ''}">${this.timeLeft}s</span>
                                </div>
                                <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full transition-all duration-1000 ease-linear ${this.timeLeft < 10 ? 'bg-red-500' : (this.settings.gameMode === 'legal' ? 'bg-indigo-500' : 'bg-cyan-500')}" style="width: ${(this.timeLeft / this.settings.duration) * 100}%"></div>
                                </div>
                            </div>

                            <div class="space-y-1 text-right flex flex-col items-end gap-2">
                                <button id="pauseBtn" class="p-2 app-btn-secondary">
                                    ${this.renderIcon('pause')}
                                </button>
                                
                                <div class="text-sm text-slate-400 font-bold tracking-wider">COMBO</div>
                                <div class="text-4xl font-mono font-bold text-yellow-400 leading-none">${this.combo}</div>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col items-center justify-center relative p-4">
                            ${this.feedback ? `
                                <div class="absolute top-6 left-1/2 -translate-x-1/2 z-50 pointer-events-none rounded-full px-4 py-2 text-sm font-bold tracking-wide border backdrop-blur-sm ${
                                    this.feedback.tone === 'miss'
                                        ? 'bg-red-900/20 text-red-300 border-red-500/30'
                                        : 'bg-green-900/20 text-green-400 border-green-500/30'
                                }">
                                    ${this.feedback.text}
                                </div>
                            ` : ''}

                            <div class="w-full max-w-4xl app-panel p-12 text-center transition-colors relative ${this.shake ? 'animate-shake' : ''}">
                                
                                ${this.currentWordData.isWeakMode ? `
                                    <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 bg-yellow-600/90 text-white px-6 py-1 rounded-full text-sm font-bold shadow-lg border border-yellow-400/50 flex items-center gap-2 animate-pulse">
                                        ${this.renderIcon('target')} 
                                        WEAK KEY CHALLENGE
                                        ${this.renderIcon('target')}
                                    </div>
                                ` : ''}

                                <div class="mb-8 space-y-2">
                                    <h2 class="text-5xl md:text-7xl font-black text-white drop-shadow-lg tracking-wide break-all leading-none">
                                        ${this.escapeHtml(this.currentWordData.text)}
                                    </h2>
                                    <p class="text-2xl text-slate-400 font-medium">
                                        ${this.escapeHtml(this.currentWordData.kana)}
                                    </p>
                                </div>

                                <div class="mt-4 flex justify-center flex-wrap gap-1 text-5xl md:text-6xl font-mono font-bold tracking-wider h-24 items-center">
                                    ${this.currentWordData.nodes.map((node, i) => {
                                        return this.renderNode(node, i === activeNodeIndex);
                                    }).join('')}
                                </div>
                            </div>

                            <div class="mt-12 text-slate-500 flex items-center gap-2">
                                ${this.settings.gameMode === 'legal' ? this.renderIcon('book-open') : this.renderIcon('keyboard')}
                                <span>
                                    ${this.settings.gameMode === 'legal' ? 'Legal Terms Mode Active' : 'Type keys to play'} (Flexible input supported)
                                </span>
                            </div>
                            
                            <div class="absolute bottom-4 right-4 text-xs font-mono select-none" style="color: var(--settings-text-subtle);">
                                © Tadashi Kotegawa
                            </div>
                        </div>
                    </div>
                `;
            }

            renderNode(node, isActive) {
                const colorClass = this.settings.gameMode === 'legal' ? 'text-indigo-400' : 'text-cyan-400';
                
                let content = '';
                
                if (this.settings.displayMode === 'ime') {
                    if (node.isDone) {
                        content = `<span class="${colorClass}">${this.escapeHtml(node.char)}</span>`;
                    } else {
                        if (this.settings.realMode) {
                            const chars = node.input.split('').map((char, idx) => {
                                const isValid = node.options.some(opt => opt.startsWith(node.input.slice(0, idx + 1)));
                                return `<span class="${isValid ? colorClass : 'text-red-500'}">${this.escapeHtml(char)}</span>`;
                            }).join('');
                            content = chars + (isActive ? '<span class="inline-block w-[2px] h-[1em] bg-yellow-400 animate-pulse align-middle ml-[1px] -mt-[0.2em]"></span>' : '');
                        } else {
                            if (node.input.length > 0) {
                                content = `<span class="${colorClass}">${this.escapeHtml(node.input)}</span>`;
                            } else {
                                content = `<span class="text-slate-700">${this.escapeHtml(node.char)}</span>`;
                            }
                        }
                    }
                } else {
                    if (this.settings.realMode) {
                        const inputChars = node.input.split('').map((char, idx) => {
                            const isValid = node.options.some(opt => opt.startsWith(node.input.slice(0, idx + 1)));
                            return `<span class="${isValid ? colorClass : 'text-red-500'}">${this.escapeHtml(char)}</span>`;
                        }).join('');
                        
                        const remaining = this.settings.displayMode === 'guide' 
                            ? `<span class="text-slate-700">${this.escapeHtml(node.selectedOption.slice(node.input.length))}</span>`
                            : '';
                        
                        const cursor = isActive && !node.isDone 
                            ? `<span class="inline-block w-[2px] h-[1em] bg-yellow-400 animate-pulse align-middle ml-[1px] -mt-[0.2em]"></span>`
                            : '';
                        
                        content = inputChars + remaining + cursor;
                    } else {
                        const bgText = this.settings.displayMode === 'guide' 
                            ? `<span class="text-slate-700">${this.escapeHtml(node.selectedOption)}</span>`
                            : `<span class="text-transparent">${this.escapeHtml(node.selectedOption)}</span>`;
                        
                        const progress = node.input.length / node.selectedOption.length * 100;
                        const overlay = `<span class="absolute top-0 left-0 ${colorClass} overflow-hidden whitespace-nowrap transition-all duration-75" style="width: ${progress}%">${this.escapeHtml(node.selectedOption)}</span>`;
                        
                        content = `<span class="relative">${bgText}${overlay}</span>`;
                    }
                }

                const spacerText = this.settings.displayMode === 'ime' ? node.char : node.selectedOption;
                const cursor = !node.isDone && !this.settings.realMode && isActive
                    ? `<div class="absolute bottom-0 h-1 bg-yellow-400 animate-pulse" style="left: ${this.settings.displayMode === 'ime' ? Math.min(node.input.length, node.char.length) : node.input.length}ch; width: 1ch"></div>`
                    : '';

                return `
                    <div class="relative inline-flex justify-center min-w-[1ch]">
                        <div class="grid grid-stack items-center justify-items-center">
                            <span class="row-start-1 col-start-1 opacity-0 select-none pointer-events-none whitespace-pre">${this.escapeHtml(spacerText)}</span>
                            <span class="row-start-1 col-start-1 whitespace-nowrap transition-colors duration-75 ${node.isDone ? colorClass : ''}">${content}</span>
                        </div>
                        ${cursor}
                    </div>
                `;
            }

            renderPauseOverlay() {
                return `
                    <div class="absolute inset-0 z-40 app-overlay flex flex-col items-center justify-center p-4 animate-in fade-in duration-200">
                        <h2 class="text-4xl font-black text-white mb-8 tracking-widest">PAUSED</h2>
                        <div class="flex flex-col gap-4 w-full max-w-xs">
                            <button id="resumeBtn" class="flex items-center justify-center gap-3 px-8 py-4 text-xl app-btn-primary">
                                ${this.renderIcon('play')} Resume
                            </button>
                            <button id="quitBtn" class="flex items-center justify-center gap-3 px-8 py-4 text-xl app-btn-secondary">
                                ${this.renderIcon('log-out')} Quit
                            </button>
                        </div>
                    </div>
                `;
            }

            renderResults() {
                const sortedMisses = Object.entries(this.missStats).sort(([, a], [, b]) => b - a);
                
                return `
                    <div class="app-shell flex flex-col items-center justify-center p-4 font-sans select-none relative">
                        ${this.renderRankingButton()}
                        ${this.showStats ? this.renderStatsPanel() : ''}
                        ${this.showRanking ? this.renderRankingModal() : ''}

                        <div class="max-w-2xl w-full app-panel p-8 space-y-8 animate-in zoom-in-95 duration-300">
                            <div class="text-center space-y-2">
                                <h2 class="text-4xl font-bold text-white">Result</h2>
                                <div class="text-6xl font-black ${this.settings.gameMode === 'legal' ? 'text-indigo-400' : 'text-cyan-400'}">${this.score.toLocaleString()} <span class="text-2xl text-slate-500">pts</span></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 rounded-xl flex items-center justify-between" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(148,163,184,0.24);">
                                    <span class="text-slate-400 flex items-center gap-2">${this.renderIcon('trophy')} Max Combo</span>
                                    <span class="text-2xl font-bold text-yellow-400">${this.maxCombo}</span>
                                </div>
                                <div class="p-4 rounded-xl flex items-center justify-between" style="background: rgba(255,255,255,0.04); border: 1px solid rgba(148,163,184,0.24);">
                                    <span class="text-slate-400 flex items-center gap-2">${this.renderIcon('alert-circle')} Total Misses</span>
                                    <span class="text-2xl font-bold text-red-400">
                                        ${Object.values(this.missStats).reduce((a, b) => a + b, 0)}
                                    </span>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-bold text-slate-300 flex items-center gap-2">
                                        ${this.renderIcon('zap')} Weak Keys Analysis
                                    </h3>
                                    <button id="viewDetailsBtn" class="text-xs flex items-center gap-1 font-bold" style="color: var(--settings-accent);">
                                        ${this.renderIcon('bar-chart-2')} View Details
                                    </button>
                                </div>
                                ${sortedMisses.length > 0 ? `
                                    <div class="grid grid-cols-5 gap-2">
                                        ${sortedMisses.slice(0, 10).map(([key, count]) => `
                                            <div class="flex flex-col items-center bg-red-900/20 border border-red-500/30 rounded-lg p-2">
                                                <span class="text-2xl font-mono font-bold text-red-400 uppercase">${this.escapeHtml(key)}</span>
                                                <span class="text-xs text-red-300">${count} miss</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-green-400 bg-green-900/20 p-3 rounded-lg text-center border border-green-500/30">
                                        Perfect Typing!
                                    </div>
                                `}
                            </div>

                            <div class="flex flex-col items-center gap-2 pt-4">
                                <button id="retryBtn" class="flex items-center gap-2 px-8 py-3 app-btn-primary">
                                    ${this.renderIcon('rotate-ccw')} もう一度挑戦
                                </button>
                                <div class="text-xs text-slate-500 font-mono">Press [SPACE] to Retry</div>
                                
                                <button id="backToMenuBtn" class="mt-2 text-sm underline" style="color: var(--settings-text-muted);">
                                    Back to Menu
                                </button>
                            </div>
                        </div>
                        <div class="absolute bottom-4 right-4 text-xs font-mono select-none" style="color: var(--settings-text-subtle);">
                            © Tadashi Kotegawa
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new GameApp();
        });
    </script>
</body>
</html>
